# Hugo博客系统 - 阿里云ACK Kubernetes部署方案

## 技术需求文档 (TRD)

**文档版本**: v1.0
**创建日期**: 2026-01-29
**作者**: 技术架构团队
**状态**: 设计阶段

---

## 目录

1. [执行摘要](#1-执行摘要)
2. [问题陈述](#2-问题陈述)
3. [架构设计](#3-架构设计)
4. [技术选型](#4-技术选型)
5. [成本分析](#5-成本分析)
6. [风险评估](#6-风险评估)
7. [实施计划](#7-实施计划)

---

## 1. 执行摘要

本文档提供Hugo静态博客系统从传统服务器部署迁移到阿里云ACK Kubernetes集群的完整技术方案。

### 1.1 核心目标

- **容器化**: 将Hugo博客和访客统计服务容器化
- **自动化**: 建立完整的CI/CD流水线
- **标准化**: 统一运维和监控体系
- **可扩展**: 为未来业务增长预留空间

### 1.2 预期收益

| 指标 | 当前 | 目标 | 提升 |
|-----|------|------|------|
| 部署时间 | 5分钟 | 2分钟 | 60% |
| 回滚时间 | 手动10分钟 | 自动30秒 | 95% |
| 可用性 | 99% | 99.9% | 0.9% |
| 监控覆盖 | 基础 | 全面 | - |

---

## 2. 问题陈述

### 2.1 当前架构分析

**部署架构**:
```
GitHub → GitHub Actions → SSH → 服务器 → Nginx
```

**存在问题**:

1. **单点故障**: 服务器宕机导致服务不可用
2. **手动运维**: SSL证书、Nginx配置需手动管理
3. **扩展困难**: 流量增长时无法快速扩容
4. **回滚复杂**: 需要手动恢复文件和配置
5. **监控缺失**: 缺乏统一的日志和监控体系
6. **环境不一致**: 开发、测试、生产环境差异大

### 2.2 技术债务

- **配置管理**: Nginx配置、SSL证书分散在服务器各处
- **依赖管理**: Python环境、系统依赖需手动安装
- **版本控制**: 无法快速回滚到历史版本
- **资源隔离**: 博客和统计服务共享系统资源

### 2.3 业务需求

- **高可用**: 支持多副本部署,避免单点故障
- **快速迭代**: 支持灰度发布和快速回滚
- **成本优化**: 按需使用资源,降低运维成本
- **安全合规**: 统一的安全策略和审计日志

---

## 3. 架构设计

### 3.1 目标架构

```
┌─────────────────────────────────────────────────────────────┐
│                        GitHub Repository                     │
│                    (Source Code + Config)                    │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ Git Push
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                      GitHub Actions                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Build Hugo   │→ │ Build Image  │→ │ Push to ACR  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                           │                                  │
│                           ▼                                  │
│                  ┌──────────────────┐                        │
│                  │ Update K8s Deploy│                        │
│                  └──────────────────┘                        │
└────────────────────────────┬────────────────────────────────┘
                             │
                             │ kubectl apply
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                   Alibaba Cloud ACK Cluster                  │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    Ingress Controller                   │ │
│  │              (Nginx Ingress / ALB Ingress)             │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                        │
│         ┌───────────┴───────────┐                           │
│         │                       │                           │
│         ▼                       ▼                           │
│  ┌─────────────┐         ┌─────────────┐                   │
│  │ Hugo Blog   │         │ Visitor     │                   │
│  │ Service     │         │ Stats API   │                   │
│  │             │         │ Service     │                   │
│  │ ┌─────────┐ │         │ ┌─────────┐ │                   │
│  │ │ Pod 1   │ │         │ │ Pod 1   │ │                   │
│  │ │ Nginx   │ │         │ │ Flask   │ │                   │
│  │ └─────────┘ │         │ └─────────┘ │                   │
│  │ ┌─────────┐ │         │             │                   │
│  │ │ Pod 2   │ │         │             │                   │
│  │ │ Nginx   │ │         │             │                   │
│  │ └─────────┘ │         │             │                   │
│  └─────────────┘         └──────┬──────┘                   │
│                                  │                           │
│                                  ▼                           │
│                          ┌──────────────┐                    │
│                          │ Persistent   │                    │
│                          │ Volume (NAS) │                    │
│                          │ SQLite DB    │                    │
│                          └──────────────┘                    │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Monitoring & Logging (SLS)                │ │
│  └─────────────────────────────────────────────────────��──┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 组件说明

#### 3.2.1 Hugo博客服务

**容器镜像**: `hugo-blog:latest`
- **基础镜像**: nginx:alpine
- **构建方式**: 多阶段构建
- **副本数**: 2个(高可用)
- **资源配额**:
  - CPU: 100m (request) / 200m (limit)
  - Memory: 128Mi (request) / 256Mi (limit)

#### 3.2.2 访客统计服务

**容器镜像**: `visitor-stats:latest`
- **基础镜像**: python:3.11-slim
- **运行方式**: Gunicorn + Flask
- **副本数**: 1个(单实例)
- **资源配额**:
  - CPU: 100m (request) / 200m (limit)
  - Memory: 128Mi (request) / 256Mi (limit)
- **持久化**: NAS存储SQLite数据库

#### 3.2.3 Ingress配置

**选项A: Nginx Ingress Controller** (推荐)
- 成本低,社区成熟
- 支持丰富的注解配置
- 适合中小规模流量

**选项B: ALB Ingress Controller**
- 阿里云原生,性能更好
- 自动管理SLB实例
- 成本较高,适合大流量场景

#### 3.2.4 存储方案

**NAS文件存储**:
- 用途: 存储SQLite数据库
- 类型: 性能型NAS
- 容量: 10GB起步
- 访问模式: ReadWriteOnce

### 3.3 网络架构

```
Internet
    │
    ▼
┌─────────────────┐
│  SLB (公网)     │  ← 绑定域名 ruyueshuke.com
│  443/80         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Ingress         │  ← SSL终止
│ Controller      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│ Hugo   │ │ Stats  │
│ Service│ │ Service│
└────────┘ └────────┘
```

**域名路由规则**:
- `ruyueshuke.com/blog/*` → Hugo Blog Service
- `ruyueshuke.com/api/stats/*` → Visitor Stats Service

### 3.4 数据流设计

#### 3.4.1 部署流程

```
1. 开发者推送代码到GitHub
   ↓
2. GitHub Actions触发
   ↓
3. 构建Hugo静态文件
   ↓
4. 构建Docker镜像
   ↓
5. 推送镜像到ACR
   ↓
6. 更新K8s Deployment
   ↓
7. K8s滚动更新Pod
   ↓
8. 健康检查通过
   ↓
9. 部署完成
```

#### 3.4.2 访问流程

```
用户请求
   ↓
SLB负载均衡
   ↓
Ingress Controller (SSL终止)
   ↓
Service (ClusterIP)
   ↓
Pod (Nginx/Flask)
   ↓
返回响应
```

---

## 4. 技术选型

### 4.1 容器运行时

**选择**: Docker
**理由**:
- 生态成熟,社区活跃
- GitHub Actions原生支持
- 开发和生产环境一致

### 4.2 镜像仓库

**选择**: 阿里云容器镜像服务 (ACR)
**理由**:
- 与ACK集成紧密
- 国内访问速度快
- 支持镜像扫描和签名

**配置**:
- 命名空间: `blog-system`
- 仓库:
  - `blog-system/hugo-blog`
  - `blog-system/visitor-stats`

### 4.3 Kubernetes版本

**选择**: ACK 1.28+
**理由**:
- 稳定版本,长期支持
- 支持最新的K8s特性
- 阿里云官方维护

### 4.4 Ingress Controller

**推荐**: Nginx Ingress Controller
**理由**:
- 开源免费
- 配置灵活
- 社区成熟

**备选**: ALB Ingress Controller
**适用场景**: 流量超过10万QPS

### 4.5 证书管理

**选择**: cert-manager
**理由**:
- 自动申请和续期Let's Encrypt证书
- 与K8s原生集成
- 无需手动管理证书

### 4.6 监控方案

**选择**: 阿里云日志服务 (SLS)
**理由**:
- 与ACK深度集成
- 支持日志采集和分析
- 提供可视化Dashboard

**监控指标**:
- Pod CPU/内存使用率
- HTTP请求QPS和延迟
- 错误率和5xx响应
- 访客统计API调用量

---

## 5. 成本分析

### 5.1 传统部署成本

| 项目 | 规格 | 月成本 |
|-----|------|--------|
| ECS服务器 | 2核4G | ¥100 |
| 公网带宽 | 5Mbps | ¥50 |
| SSL证书 | 免费 | ¥0 |
| **总计** | - | **¥150/月** |

### 5.2 K8s部署成本

#### 方案A: 托管版ACK (推荐)

| 项目 | 规格 | 月成本 | 说明 |
|-----|------|--------|------|
| ACK托管费 | 标准版 | ¥0 | 免费 |
| Worker节点 | 2核4G × 2 | ¥200 | 高可用 |
| SLB | 共享型 | ¥20 | 按流量计费 |
| NAS存储 | 10GB | ¥5 | 性能型 |
| ACR镜像仓库 | 个人版 | ¥0 | 免费 |
| SLS日志服务 | 1GB/天 | ¥30 | 可选 |
| **总计** | - | **¥255/月** | 含监控 |

#### 方案B: 单节点ACK (成本优化)

| 项目 | 规格 | 月成本 | 说明 |
|-----|------|--------|------|
| ACK托管费 | 标准版 | ¥0 | 免费 |
| Worker节点 | 2核4G × 1 | ¥100 | 单节点 |
| SLB | 共享型 | ¥20 | 按流量计费 |
| NAS存储 | 10GB | ¥5 | 性能型 |
| ACR镜像仓库 | 个人版 | ¥0 | 免费 |
| **总计** | - | **¥125/月** | 无监控 |

### 5.3 成本对比分析

| 对比项 | 传统部署 | K8s单节点 | K8s双节点 |
|-------|---------|-----------|-----------|
| 月成本 | ¥150 | ¥125 | ¥255 |
| 高可用 | ❌ | ❌ | ✅ |
| 自动扩容 | ❌ | ✅ | ✅ |
| 监控日志 | 基础 | 基础 | 完善 |
| 运维复杂度 | 低 | 中 | 中 |
| 学习成本 | 低 | 高 | 高 |

**结论**:
- **个人博客**: 推荐传统部署或K8s单节点
- **企业博客**: 推荐K8s双节点
- **学习目的**: 推荐K8s单节点

### 5.4 隐性成本

**传统部署**:
- 手动运维时间: 2小时/月
- 故障恢复时间: 30分钟/次
- 证书续期: 1小时/年

**K8s部署**:
- 初始学习成本: 40小时
- 日常运维时间: 1小时/月
- 故障自动恢复: 5分钟/次

---

## 6. 风险评估

### 6.1 技术风险

| 风险 | 等级 | 影响 | 缓解措施 |
|-----|------|------|---------|
| K8s学习曲线陡峭 | 高 | 延期上线 | 提供详细文档和培训 |
| 镜像构建失败 | 中 | 部署中断 | 多阶段构建,充分测试 |
| 存储数据丢失 | 高 | 数据永久丢失 | NAS自动备份 |
| 证书自动续期失败 | 中 | HTTPS不可用 | 监控告警 |
| 资源配额不足 | 低 | Pod无法启动 | 合理设置资源限制 |

### 6.2 运维风险

| 风险 | 等级 | 影响 | 缓解措施 |
|-----|------|------|---------|
| 配置错误导致服务不可用 | 中 | 服务中断 | 灰度发布,快速回滚 |
| 监控告警缺失 | 中 | 故障发现延迟 | 完善监控体系 |
| 成本超预算 | 低 | 财务压力 | 定期审查资源使用 |
| 依赖服务故障 | 低 | 部署失败 | 多可用区部署 |

### 6.3 业务风险

| 风险 | 等级 | 影响 | 缓解措施 |
|-----|------|------|---------|
| 迁移期间服务中断 | 高 | 用户体验下降 | 蓝绿部署 |
| 访客统计数据丢失 | 中 | 数据不准确 | 迁移前备份 |
| SEO排名下降 | 低 | 流量下降 | 保持URL不变 |

---

## 7. 实施计划

### 7.1 阶段划分

#### 阶段1: 准备阶段 (1-2天)

**目标**: 完成环境准备和配置
**任务**:
- [ ] 创建阿里云ACK集群
- [ ] 配置kubectl本地访问
- [ ] 创建ACR镜像仓库
- [ ] 准备域名和SSL证书

**交付物**:
- ACK集群访问凭证
- ACR仓库地址
- kubectl配置文件

#### 阶段2: 容器化阶段 (2-3天)

**目标**: 完成应用容器化
**任务**:
- [ ] 编写Hugo博客Dockerfile
- [ ] 编写访客统计Dockerfile
- [ ] 本地构建和测试镜像
- [ ] 推送镜像到ACR

**交付物**:
- Dockerfile文件
- 镜像构建脚本
- 本地测试报告

#### 阶段3: K8s配置阶段 (2-3天)

**目标**: 完成K8s资源配置
**任务**:
- [ ] 编写Deployment配置
- [ ] 编写Service配置
- [ ] 编写Ingress配置
- [ ] 配置ConfigMap和Secret
- [ ] 配置PersistentVolume

**交付物**:
- 完整的K8s YAML文件
- 配置说明文档

#### 阶段4: CI/CD改造阶段 (2-3天)

**目标**: 完成自动化部署流程
**任务**:
- [ ] 改造GitHub Actions工作流
- [ ] 配置镜像自动构建
- [ ] 配置K8s自动部署
- [ ] 测试完整部署流程

**交付物**:
- 新的GitHub Actions配置
- 部署脚本
- 测试报告

#### 阶段5: 测试验证阶段 (1-2天)

**目标**: 验证系统功能和性能
**任务**:
- [ ] 功能测试(博客访问、统计API)
- [ ] 性能测试(并发访问)
- [ ] 故障恢复测试
- [ ] 回滚测试

**交付物**:
- 测试用例和结果
- 性能测试报告

#### 阶段6: 上线切换阶段 (1天)

**目标**: 完成生产环境切换
**任务**:
- [ ] 备份现有数据
- [ ] 迁移访客统计数据
- [ ] 切换DNS解析
- [ ] 监控系统运行

**交付物**:
- 数据备份
- 切换方案
- 回滚预案

#### 阶段7: 监控优化阶段 (持续)

**目标**: 完善监控和优化系统
**任务**:
- [ ] 配置SLS日志采集
- [ ] 配置告警规则
- [ ] 优化资源配额
- [ ] 编写运维文档

**交付物**:
- 监控Dashboard
- 告警规则
- 运维手册

### 7.2 时间线

```
Week 1: 准备 + 容器化
Week 2: K8s配置 + CI/CD改造
Week 3: 测试验证 + 上线切换
Week 4: 监控优化 + 文档完善
```

### 7.3 里程碑

- **M1**: 完成ACK集群创建 (Day 2)
- **M2**: 完成镜像构建 (Day 5)
- **M3**: 完成K8s配置 (Day 8)
- **M4**: 完成CI/CD改造 (Day 11)
- **M5**: 完成测试验证 (Day 13)
- **M6**: 完成生产上线 (Day 14)

### 7.4 回滚策略

**触发条件**:
- 部署后5xx错误率超过5%
- 部署后响应时间超过3秒
- 关键功能不可用

**回滚步骤**:
```bash
# 1. 回滚到上一版本
kubectl rollout undo deployment/hugo-blog -n blog

# 2. 验证回滚结果
kubectl rollout status deployment/hugo-blog -n blog

# 3. 检查Pod状态
kubectl get pods -n blog

# 4. 验证服务可用性
curl https://ruyueshuke.com/blog/
```

---

## 8. 决策矩阵

### 8.1 是否迁移到K8s?

| 场景 | 推荐方案 | 理由 |
|-----|---------|------|
| 个人博客,流量<1000PV/天 | 保持传统部署 | 成本低,运维简单 |
| 企业博客,需要高可用 | 迁移到K8s | 高可用,易扩展 |
| 学习K8s技术 | 迁移到K8s | 实战经验 |
| 多个服务需要统一管理 | 迁移到K8s | 统一运维 |

### 8.2 单节点 vs 双节点?

| 对比项 | 单节点 | 双节点 |
|-------|--------|--------|
| 成本 | ¥125/月 | ¥255/月 |
| 高可用 | ❌ | ✅ |
| 适用场景 | 个人博客 | 企业博客 |
| 推荐指数 | ⭐⭐⭐ | ⭐⭐⭐⭐ |

### 8.3 Nginx Ingress vs ALB Ingress?

| 对比项 | Nginx Ingress | ALB Ingress |
|-------|---------------|-------------|
| 成本 | 低 | 高 |
| 性能 | 中 | 高 |
| 配置复杂度 | 低 | 中 |
| 适用流量 | <10万QPS | >10万QPS |
| 推荐指数 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## 9. 附录

### 9.1 术语表

- **ACK**: Alibaba Cloud Container Service for Kubernetes
- **ACR**: Alibaba Cloud Container Registry
- **SLB**: Server Load Balancer
- **NAS**: Network Attached Storage
- **SLS**: Simple Log Service
- **PV**: PersistentVolume
- **PVC**: PersistentVolumeClaim

### 9.2 参考文档

- [阿里云ACK官方文档](https://help.aliyun.com/product/85222.html)
- [Kubernetes官方文档](https://kubernetes.io/docs/)
- [Nginx Ingress Controller](https://kubernetes.github.io/ingress-nginx/)
- [cert-manager文档](https://cert-manager.io/docs/)

### 9.3 联系方式

- **技术支持**: service@ruyueshuke.com
- **项目仓库**: https://github.com/Maneng/blog

---

**文档结束**
