name: Deploy to Kubernetes (ACK)

on:
  push:
    branches:
      - main  # mainåˆ†æ”¯æ¨é€æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é˜¿é‡Œäº‘ACRé…ç½®
  ACR_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ACR_NAMESPACE: blog-system
  HUGO_IMAGE: hugo-blog
  STATS_IMAGE: visitor-stats

  # Kubernetesé…ç½®
  K8S_NAMESPACE: blog

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      # ============================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # æ‹‰å–ä¸»é¢˜å­æ¨¡å—
          fetch-depth: 0    # è·å–å®Œæ•´å†å²

      # ============================================
      # æ­¥éª¤2: å®‰è£…Hugo
      # ============================================
      - name: ğŸ”§ Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      # ============================================
      # æ­¥éª¤3: æ„å»ºHugoé™æ€æ–‡ä»¶
      # ============================================
      - name: ğŸ—ï¸ Build Hugo site
        run: hugo --minify --gc

      # ============================================
      # æ­¥éª¤4: è®¾ç½®Docker Buildx
      # ============================================
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # æ­¥éª¤5: ç™»å½•é˜¿é‡Œäº‘ACR
      # ============================================
      - name: ğŸ” Login to Alibaba Cloud ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ============================================
      # æ­¥éª¤6: æ„å»ºå¹¶æ¨é€Hugoåšå®¢é•œåƒ
      # ============================================
      - name: ğŸš€ Build and push Hugo blog image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: k8s-deployment/dockerfiles/hugo-blog.Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.HUGO_IMAGE }}:latest
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.HUGO_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================
      # æ­¥éª¤7: æ„å»ºå¹¶æ¨é€è®¿å®¢ç»Ÿè®¡é•œåƒ
      # ============================================
      - name: ğŸš€ Build and push visitor stats image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: k8s-deployment/dockerfiles/visitor-stats.Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.STATS_IMAGE }}:latest
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.STATS_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================
      # æ­¥éª¤8: é…ç½®kubectl
      # ============================================
      - name: âš™ï¸ Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # ============================================
      # æ­¥éª¤9: éªŒè¯é›†ç¾¤è¿æ¥
      # ============================================
      - name: âœ… Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      # ============================================
      # æ­¥éª¤10: æ›´æ–°Hugoåšå®¢Deployment
      # ============================================
      - name: ğŸ”„ Update Hugo blog deployment
        run: |
          kubectl set image deployment/hugo-blog \
            nginx=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.HUGO_IMAGE }}:${{ github.sha }} \
            -n ${{ env.K8S_NAMESPACE }}

          kubectl rollout status deployment/hugo-blog -n ${{ env.K8S_NAMESPACE }} --timeout=300s

      # ============================================
      # æ­¥éª¤11: æ›´æ–°è®¿å®¢ç»Ÿè®¡Deployment
      # ============================================
      - name: ğŸ”„ Update visitor stats deployment
        run: |
          kubectl set image deployment/visitor-stats \
            flask=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.STATS_IMAGE }}:${{ github.sha }} \
            -n ${{ env.K8S_NAMESPACE }}

          kubectl rollout status deployment/visitor-stats -n ${{ env.K8S_NAMESPACE }} --timeout=300s

      # ============================================
      # æ­¥éª¤12: éªŒè¯éƒ¨ç½²çŠ¶æ€
      # ============================================
      - name: ğŸ“Š Verify deployment
        run: |
          echo "========================================="
          echo "PodçŠ¶æ€:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}

          echo ""
          echo "========================================="
          echo "ServiceçŠ¶æ€:"
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}

          echo ""
          echo "========================================="
          echo "IngressçŠ¶æ€:"
          kubectl get ingress -n ${{ env.K8S_NAMESPACE }}

      # ============================================
      # æ­¥éª¤13: å¥åº·æ£€æŸ¥
      # ============================================
      - name: ğŸ¥ Health check
        run: |
          # ç­‰å¾…30ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 30

          # æ£€æŸ¥åšå®¢æ˜¯å¦å¯è®¿é—®
          INGRESS_IP=$(kubectl get ingress blog-ingress -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          if [ -n "$INGRESS_IP" ]; then
            echo "Ingress IP: $INGRESS_IP"
            # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šï¿½ï¿½åº·æ£€æŸ¥é€»è¾‘
          else
            echo "Ingress IPæœªåˆ†é…,è·³è¿‡å¥åº·æ£€æŸ¥"
          fi

      # ============================================
      # æ­¥éª¤14: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      # ============================================
      - name: âœ… Deployment successful
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo "åšå®¢åœ°å€: https://ruyueshuke.com/blog/"
          echo "APIåœ°å€: https://ruyueshuke.com/api/stats"
          echo "Git Commit: ${{ github.sha }}"

      # ============================================
      # æ­¥éª¤15: éƒ¨ç½²å¤±è´¥å¤„ç†
      # ============================================
      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "éƒ¨ç½²å¤±è´¥,æŸ¥çœ‹æ—¥å¿—:"
          kubectl logs -l app=hugo-blog -n ${{ env.K8S_NAMESPACE }} --tail=50 || true
          kubectl logs -l app=visitor-stats -n ${{ env.K8S_NAMESPACE }} --tail=50 || true
          kubectl get events -n ${{ env.K8S_NAMESPACE }} --sort-by='.lastTimestamp' | tail -20
