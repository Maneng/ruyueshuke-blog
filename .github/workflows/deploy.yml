name: Deploy Hugo Blog

on:
  push:
    branches:
      - main  # mainåˆ†æ”¯æœ‰pushæ—¶è§¦å‘

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true  # æ‹‰å–ä¸»é¢˜å­æ¨¡å—
          fetch-depth: 0    # è·å–å®Œæ•´å†å²ï¼ˆHugoéœ€è¦ï¼‰

      # æ­¥éª¤2ï¼šå®‰è£…Hugo
      - name: ğŸ”§ Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      # æ­¥éª¤3ï¼šæ„å»ºç½‘ç«™
      - name: ğŸ—ï¸ Build website
        run: hugo --minify

      # æ­¥éª¤4ï¼šæ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: ğŸ“Š Show build info
        run: |
          echo "æ„å»ºå®Œæˆï¼"
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lah public/
          echo "---"
          echo "æ–‡ä»¶æ€»å¤§å°ï¼š"
          du -sh public/

      # æ­¥éª¤5ï¼šéƒ¨ç½²Hugoåšå®¢åˆ°blogå­ç›®å½•
      - name: ğŸš€ Deploy Hugo blog to server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          SOURCE: "public/"
          TARGET: "/usr/share/testpage/blog/"
          ARGS: "-avzr --delete --exclude='.well-known'"
          SCRIPT_BEFORE: |
            echo "================================"
            echo "å¼€å§‹éƒ¨ç½²Hugoåšå®¢åˆ°æœåŠ¡å™¨"
            echo "æœåŠ¡å™¨ç”¨æˆ·: $(whoami)"
            echo "åˆ›å»ºblogç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰"
            mkdir -p /usr/share/testpage/blog
            echo "ç›®æ ‡ç›®å½•: /usr/share/testpage/blog/"
            echo "================================"
          SCRIPT_AFTER: |
            echo "================================"
            echo "Hugoåšå®¢éƒ¨ç½²å®Œæˆï¼"
            echo "åšå®¢æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -lth /usr/share/testpage/blog/ | head -10
            echo "================================"

      # æ­¥éª¤6ï¼šéƒ¨ç½²index.htmlåˆ°æ ¹ç›®å½•
      - name: ğŸ“„ Deploy landing page to server
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SERVER_HOST }}
          REMOTE_USER: ${{ secrets.SERVER_USER }}
          SOURCE: "index.html"
          TARGET: "/usr/share/testpage/"
          ARGS: "-avz"
          SCRIPT_AFTER: |
            echo "================================"
            echo "é¦–é¡µéƒ¨ç½²å®Œæˆï¼"
            echo "æ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -lth /usr/share/testpage/ | head -5
            echo "================================"
            echo "ç½‘ç«™åœ°å€: https://47.93.8.184/"
            echo "åšå®¢åœ°å€: https://47.93.8.184/blog/"
            echo "================================"

      # æ­¥éª¤7ï¼šé€šçŸ¥éƒ¨ç½²ç»“æœ
      - name: âœ… Deployment successful
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "é¦–é¡µåœ°å€: https://47.93.8.184/"
          echo "åšå®¢åœ°å€: https://47.93.8.184/blog/"

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
