---
title: "Clusteré›†ç¾¤ï¼šRedisçš„æ°´å¹³æ‰©å±•æ–¹æ¡ˆ"
date: 2025-01-21T21:30:00+08:00
draft: false
tags: ["Redis", "Cluster", "é›†ç¾¤", "åˆ†ç‰‡"]
categories: ["æŠ€æœ¯"]
description: "æ·±å…¥ç†è§£Redis Clusterçš„åˆ†ç‰‡æœºåˆ¶ã€æ§½ä½åˆ†é…ã€èŠ‚ç‚¹é€šä¿¡ã€æ•…éšœè½¬ç§»ç­‰æ ¸å¿ƒåŸç†ï¼ŒæŒæ¡å¤§è§„æ¨¡Redisé›†ç¾¤çš„è®¾è®¡ä¸è¿ç»´"
weight: 22
stage: 2
stageTitle: "æ¶æ„åŸç†ç¯‡"
---

## å¼•è¨€

å•ä¸ªRediså®ä¾‹å†…å­˜æœ‰é™ï¼ˆé€šå¸¸16-64GBï¼‰ï¼Œ**å¦‚ä½•å­˜å‚¨TBçº§æ•°æ®ï¼Ÿå¦‚ä½•å®ç°æ°´å¹³æ‰©å±•ï¼Ÿ** **Redis Cluster**æä¾›äº†åŸç”Ÿçš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

## ä¸€ã€Clusteræ¦‚è¿°

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦Clusterï¼Ÿ

**ä¸»ä»å¤åˆ¶+å“¨å…µçš„å±€é™**ï¼š
```
ä¸»ä»æ¶æ„ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Master   â”‚  (å•èŠ‚ç‚¹å­˜å‚¨æ‰€æœ‰æ•°æ®)
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ å¤åˆ¶
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Slave1  â”‚ Slave2 â”‚  (ä»…è¯»æ‰©å±•ï¼Œä¸èƒ½å†™æ‰©å±•)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
âŒ å•ç‚¹å®¹é‡ç“¶é¢ˆï¼ˆå—é™äºå•æœºå†…å­˜ï¼‰
âŒ å†™æ€§èƒ½æ— æ³•æ‰©å±•ï¼ˆæ‰€æœ‰å†™æ“ä½œéƒ½åœ¨ä¸»èŠ‚ç‚¹ï¼‰
âŒ ä¸»èŠ‚ç‚¹æ•…éšœå½±å“æ‰€æœ‰æ•°æ®è®¿é—®
```

**Clusteråˆ†ç‰‡æ¶æ„**ï¼š
```
Clusterï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”
  â”‚Master1â”‚  â”‚Master2â”‚  â”‚Master3â”‚  (æ•°æ®åˆ†ç‰‡å­˜å‚¨)
  â”‚Slave1 â”‚  â”‚Slave2 â”‚  â”‚Slave3 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“          â†“          â†“
  å­˜å‚¨1/3    å­˜å‚¨1/3    å­˜å‚¨1/3
   æ•°æ®        æ•°æ®        æ•°æ®

ä¼˜åŠ¿ï¼š
âœ… å®¹é‡æ‰©å±•ï¼ˆæ·»åŠ èŠ‚ç‚¹ï¼‰
âœ… å†™æ€§èƒ½æ‰©å±•ï¼ˆå¤šä¸ªä¸»èŠ‚ç‚¹ï¼‰
âœ… é«˜å¯ç”¨ï¼ˆæ¯ä¸ªä¸»èŠ‚ç‚¹æœ‰ä»èŠ‚ç‚¹ï¼‰
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

1. **åˆ†ç‰‡ï¼ˆShardingï¼‰**ï¼šæ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹
2. **æ§½ä½ï¼ˆSlotï¼‰**ï¼š16384ä¸ªæ§½ä½ï¼Œåˆ†é…ç»™ä¸åŒèŠ‚ç‚¹
3. **èŠ‚ç‚¹ï¼ˆNodeï¼‰**ï¼šç‹¬ç«‹çš„Rediså®ä¾‹
4. **ä¸»ä»å¤åˆ¶**ï¼šæ¯ä¸ªä¸»èŠ‚ç‚¹å¯æœ‰å¤šä¸ªä»èŠ‚ç‚¹

## äºŒã€æ§½ä½æœºåˆ¶

### 2.1 ä»€ä¹ˆæ˜¯æ§½ä½ï¼Ÿ

**Redis Clusterå…±æœ‰16384ä¸ªæ§½ä½ï¼ˆ0-16383ï¼‰**ï¼š
```
æ§½ä½åˆ†é…ç¤ºä¾‹ï¼ˆ3ä¸ªä¸»èŠ‚ç‚¹ï¼‰ï¼š
Master1ï¼š0-5460    (5461ä¸ªæ§½ä½)
Master2ï¼š5461-10922  (5461ä¸ªæ§½ä½)
Master3ï¼š10923-16383 (5461ä¸ªæ§½ä½)
```

### 2.2 keyåˆ°æ§½ä½çš„æ˜ å°„

**è®¡ç®—å…¬å¼**ï¼š
```
slot = CRC16(key) % 16384

ç¤ºä¾‹ï¼š
key="user:1001"
CRC16("user:1001") = 51234
slot = 51234 % 16384 = 1698

æŸ¥æ‰¾ï¼šslot 1698åœ¨Master1ä¸Š â†’ è®¿é—®Master1
```

**å“ˆå¸Œæ ‡ç­¾ï¼ˆHash Tagï¼‰**ï¼š
```java
// ç¡®ä¿å¤šä¸ªkeyåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹
jedis.set("{user:1001}:name", "Alice");
jedis.set("{user:1001}:age", "25");

// {user:1001}éƒ¨åˆ†ç”¨äºè®¡ç®—slot
// ä¸¤ä¸ªkeyéƒ½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Š
```

### 2.3 æ§½ä½åˆ†é…

**æ‰‹åŠ¨åˆ†é…**ï¼š
```bash
# æ·»åŠ èŠ‚ç‚¹
redis-cli --cluster add-node 127.0.0.1:7000 127.0.0.1:7001

# åˆ†é…æ§½ä½
redis-cli --cluster reshard 127.0.0.1:7000
# æç¤ºï¼šHow many slots? 5461
# æç¤ºï¼šWhat is the receiving node ID? <node-id>
# æç¤ºï¼šSource node? all
```

**è‡ªåŠ¨åˆ†é…**ï¼š
```bash
# åˆ›å»ºé›†ç¾¤ï¼ˆè‡ªåŠ¨åˆ†é…æ§½ä½ï¼‰
redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
  --cluster-replicas 1
```

## ä¸‰ã€èŠ‚ç‚¹é€šä¿¡

### 3.1 Gossipåè®®

**æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤é›†ç¾¤å…ƒæ•°æ®**ï¼š
- æ‰€æœ‰èŠ‚ç‚¹åˆ—è¡¨
- æ§½ä½åˆ†é…ä¿¡æ¯
- èŠ‚ç‚¹çŠ¶æ€ï¼ˆåœ¨çº¿/ä¸‹çº¿ï¼‰

**é€šä¿¡æ–¹å¼**ï¼š
```
èŠ‚ç‚¹1 â†’ èŠ‚ç‚¹2ï¼šå‘é€PINGï¼ˆæºå¸¦éƒ¨åˆ†å…ƒæ•°æ®ï¼‰
èŠ‚ç‚¹2 â†’ èŠ‚ç‚¹1ï¼šå›å¤PONGï¼ˆæºå¸¦éƒ¨åˆ†å…ƒæ•°æ®ï¼‰

æ•ˆæœï¼š
- æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå…ƒæ•°æ®æœ€ç»ˆåœ¨æ‰€æœ‰èŠ‚ç‚¹åŒæ­¥ï¼‰
- å»ä¸­å¿ƒåŒ–ï¼ˆæ— éœ€é…ç½®ä¸­å¿ƒï¼‰
```

### 3.2 èŠ‚ç‚¹å‘ç°

**æ–°èŠ‚ç‚¹åŠ å…¥**ï¼š
```
1. redis-cli --cluster add-node <new-node> <existing-node>
2. æ–°èŠ‚ç‚¹ä¸é›†ç¾¤ä¸­ä»»ä¸€èŠ‚ç‚¹å»ºç«‹è¿æ¥
3. é€šè¿‡Gossipåè®®ï¼Œæ–°èŠ‚ç‚¹å‘ç°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹
4. æ‰€æœ‰èŠ‚ç‚¹å‘ç°æ–°èŠ‚ç‚¹
```

### 3.3 æ•…éšœæ£€æµ‹

```
èŠ‚ç‚¹1å®šæœŸå‘æ‰€æœ‰èŠ‚ç‚¹å‘é€PINGï¼š
  â†“
èŠ‚ç‚¹2è¶…æ—¶æ— å“åº”ï¼ˆè¶…è¿‡cluster-node-timeoutï¼‰
  â†“
èŠ‚ç‚¹1æ ‡è®°èŠ‚ç‚¹2ä¸ºPFAILï¼ˆç–‘ä¼¼ä¸‹çº¿ï¼‰
  â†“
èŠ‚ç‚¹1é€šè¿‡Gossipé€šçŸ¥å…¶ä»–èŠ‚ç‚¹
  â†“
å¤šæ•°ä¸»èŠ‚ç‚¹ä¹Ÿè®¤ä¸ºèŠ‚ç‚¹2ä¸‹çº¿
  â†“
æ ‡è®°èŠ‚ç‚¹2ä¸ºFAILï¼ˆç¡®è®¤ä¸‹çº¿ï¼‰
  â†“
è§¦å‘æ•…éšœè½¬ç§»
```

## å››ã€å®¢æˆ·ç«¯é‡å®šå‘

### 4.1 MOVEDé‡å®šå‘

**åœºæ™¯**ï¼škeyä¸åœ¨å½“å‰èŠ‚ç‚¹

```
å®¢æˆ·ç«¯ â†’ èŠ‚ç‚¹1ï¼šGET user:1001
          â†“
       è®¡ç®—slot=1698ï¼Œå‘ç°slotåœ¨èŠ‚ç‚¹2
          â†“
èŠ‚ç‚¹1 â†’ å®¢æˆ·ç«¯ï¼šMOVED 1698 127.0.0.1:7001
          â†“
å®¢æˆ·ç«¯ â†’ èŠ‚ç‚¹2ï¼šGET user:1001
          â†“
èŠ‚ç‚¹2 â†’ å®¢æˆ·ç«¯ï¼šè¿”å›value
```

**å®¢æˆ·ç«¯ä¼˜åŒ–**ï¼š
- ç¼“å­˜æ§½ä½åˆ†é…ä¿¡æ¯
- ç›´æ¥è®¿é—®ç›®æ ‡èŠ‚ç‚¹ï¼ˆé¿å…é‡å®šå‘ï¼‰

### 4.2 ASKé‡å®šå‘

**åœºæ™¯**ï¼šæ§½ä½æ­£åœ¨è¿ç§»

```
æ§½ä½1698æ­£åœ¨ä»èŠ‚ç‚¹1è¿ç§»åˆ°èŠ‚ç‚¹2ï¼š
  â†“
å®¢æˆ·ç«¯ â†’ èŠ‚ç‚¹1ï¼šGET user:1001
          â†“
èŠ‚ç‚¹1æŸ¥æ‰¾ï¼škeyå·²è¿ç§» â†’ è¿”å›ASK 1698 127.0.0.1:7002
          â†“
å®¢æˆ·ç«¯ â†’ èŠ‚ç‚¹2ï¼šASKING + GET user:1001
          â†“
èŠ‚ç‚¹2 â†’ å®¢æˆ·ç«¯ï¼šè¿”å›value
```

**MOVED vs ASK**ï¼š
- **MOVED**ï¼šæ§½ä½æ°¸ä¹…åˆ†é…ç»™å…¶ä»–èŠ‚ç‚¹
- **ASK**ï¼šæ§½ä½ä¸´æ—¶è¿ç§»ï¼ˆè¿ç§»å®Œæˆåæ¢å¤ï¼‰

## äº”ã€æ•…éšœè½¬ç§»

### 5.1 æ•…éšœæ£€æµ‹

```
èŠ‚ç‚¹1ï¼ˆä¸»èŠ‚ç‚¹ï¼‰å®•æœºï¼š
  â†“
ä»èŠ‚ç‚¹1-1æ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹ä¸‹çº¿
  â†“
å‘èµ·é€‰ä¸¾ï¼šå‘å…¶ä»–ä¸»èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨
  â†“
è·å¾—å¤šæ•°æŠ•ç¥¨ â†’ æå‡ä¸ºä¸»èŠ‚ç‚¹
  â†“
æ¥ç®¡åŸä¸»èŠ‚ç‚¹çš„æ§½ä½
```

### 5.2 é€‰ä¸¾è§„åˆ™

**æŠ•ç¥¨è§„åˆ™**ï¼š
1. æ¯ä¸ªä¸»èŠ‚ç‚¹æœ‰1ç¥¨
2. ä»èŠ‚ç‚¹offsetè¶Šå¤§ï¼ˆæ•°æ®è¶Šæ–°ï¼‰ï¼Œè¶Šå®¹æ˜“è·å¾—æŠ•ç¥¨
3. è·å¾—å¤šæ•°ç¥¨ï¼ˆN/2+1ï¼‰çš„ä»èŠ‚ç‚¹æˆä¸ºæ–°ä¸»èŠ‚ç‚¹

### 5.3 æ‰‹åŠ¨æ•…éšœè½¬ç§»

```bash
# åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œ
127.0.0.1:7001> CLUSTER FAILOVER

# å¼ºåˆ¶æ•…éšœè½¬ç§»ï¼ˆä¸ç­‰å¾…æ•°æ®åŒæ­¥ï¼‰
127.0.0.1:7001> CLUSTER FAILOVER FORCE
```

## å…­ã€é›†ç¾¤æ‰©å®¹ä¸ç¼©å®¹

### 6.1 æ‰©å®¹

**æ·»åŠ ä¸»èŠ‚ç‚¹**ï¼š
```bash
# 1. æ·»åŠ èŠ‚ç‚¹
redis-cli --cluster add-node 127.0.0.1:7003 127.0.0.1:7000

# 2. åˆ†é…æ§½ä½
redis-cli --cluster reshard 127.0.0.1:7000
# ä»ç°æœ‰èŠ‚ç‚¹è¿ç§»éƒ¨åˆ†æ§½ä½åˆ°æ–°èŠ‚ç‚¹

# 3. æ·»åŠ ä»èŠ‚ç‚¹
redis-cli --cluster add-node 127.0.0.1:7004 127.0.0.1:7003 --cluster-slave
```

### 6.2 ç¼©å®¹

**åˆ é™¤èŠ‚ç‚¹**ï¼š
```bash
# 1. è¿ç§»æ§½ä½åˆ°å…¶ä»–èŠ‚ç‚¹
redis-cli --cluster reshard 127.0.0.1:7000
# å°†èŠ‚ç‚¹3çš„æ§½ä½å…¨éƒ¨è¿ç§»èµ°

# 2. åˆ é™¤ä»èŠ‚ç‚¹
redis-cli --cluster del-node 127.0.0.1:7004 <node-id>

# 3. åˆ é™¤ä¸»èŠ‚ç‚¹
redis-cli --cluster del-node 127.0.0.1:7003 <node-id>
```

## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 èŠ‚ç‚¹è§„åˆ’

âœ… **æ¨è**ï¼š
- **æœ€å°‘6ä¸ªèŠ‚ç‚¹**ï¼ˆ3ä¸»3ä»ï¼‰
- **å¥‡æ•°ä¸ªä¸»èŠ‚ç‚¹**ï¼ˆ3ã€5ã€7ï¼‰
- **åˆ†å¸ƒå¼éƒ¨ç½²**ï¼ˆä¸åŒæœºå™¨/æœºæˆ¿ï¼‰

### 7.2 æ§½ä½åˆ†é…

```
æ¨èï¼š
- 3ä¸ªä¸»èŠ‚ç‚¹ï¼šæ¯ä¸ª5461-5462ä¸ªæ§½ä½
- 5ä¸ªä¸»èŠ‚ç‚¹ï¼šæ¯ä¸ªçº¦3277ä¸ªæ§½ä½

é¿å…ï¼š
- æ§½ä½åˆ†é…ä¸å‡ï¼ˆå¯¼è‡´çƒ­ç‚¹ï¼‰
```

### 7.3 ç›‘æ§æŒ‡æ ‡

```bash
# é›†ç¾¤çŠ¶æ€
redis-cli --cluster check 127.0.0.1:7000

# å…³é”®æŒ‡æ ‡ï¼š
# - cluster_state: ok/fail
# - cluster_slots_assigned: 16384ï¼ˆå…¨éƒ¨åˆ†é…ï¼‰
# - cluster_slots_ok: 16384ï¼ˆå…¨éƒ¨æ­£å¸¸ï¼‰
# - cluster_known_nodes: èŠ‚ç‚¹æ•°é‡
```

### 7.4 å®¢æˆ·ç«¯é…ç½®

**Jedisç¤ºä¾‹**ï¼š
```java
import redis.clients.jedis.JedisCluster;

Set<HostAndPort> nodes = new HashSet<>();
nodes.add(new HostAndPort("127.0.0.1", 7000));
nodes.add(new HostAndPort("127.0.0.1", 7001));
nodes.add(new HostAndPort("127.0.0.1", 7002));

JedisCluster cluster = new JedisCluster(nodes);

// ä½¿ç”¨
cluster.set("key", "value");
String value = cluster.get("key");

// æ‰¹é‡æ“ä½œï¼ˆåŒä¸€ä¸ªå“ˆå¸Œæ ‡ç­¾ï¼‰
cluster.mset("{user:1001}:name", "Alice", "{user:1001}:age", "25");
```

## å…«ã€Clusterå±€é™æ€§

### 8.1 ä¸æ”¯æŒçš„å‘½ä»¤

```bash
# âŒ å¤škeyæ“ä½œï¼ˆkeyåœ¨ä¸åŒèŠ‚ç‚¹ï¼‰
MGET key1 key2 key3  # å¯èƒ½åœ¨ä¸åŒèŠ‚ç‚¹

# âœ… ä½¿ç”¨å“ˆå¸Œæ ‡ç­¾
MGET {user}:key1 {user}:key2  # ç¡®ä¿åœ¨åŒä¸€èŠ‚ç‚¹
```

### 8.2 äº‹åŠ¡é™åˆ¶

```bash
# âŒ å¤škeyäº‹åŠ¡ï¼ˆkeyåœ¨ä¸åŒèŠ‚ç‚¹ï¼‰
MULTI
SET key1 value1  # å¯èƒ½åœ¨èŠ‚ç‚¹1
SET key2 value2  # å¯èƒ½åœ¨èŠ‚ç‚¹2
EXEC

# âœ… ä½¿ç”¨å“ˆå¸Œæ ‡ç­¾æˆ–Luaè„šæœ¬
```

### 8.3 æ€§èƒ½å¼€é”€

```
Gossipåè®®ï¼š
- æ¯ç§’å‘é€PING/PONGæ¶ˆæ¯
- å…ƒæ•°æ®ä¼ æ’­
- ç½‘ç»œå¸¦å®½å ç”¨ï¼ˆèŠ‚ç‚¹è¶Šå¤šè¶Šæ˜æ˜¾ï¼‰

å»ºè®®ï¼š
- èŠ‚ç‚¹æ•° < 1000
- ä½¿ç”¨ä¸‡å…†ç½‘ç»œ
```

## ä¹ã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **Clusteråˆ†ç‰‡**
   - 16384ä¸ªæ§½ä½
   - CRC16(key) % 16384
   - å“ˆå¸Œæ ‡ç­¾ç¡®ä¿å¤škeyåœ¨åŒä¸€èŠ‚ç‚¹

2. **èŠ‚ç‚¹é€šä¿¡**
   - Gossipåè®®
   - å»ä¸­å¿ƒåŒ–
   - æœ€ç»ˆä¸€è‡´æ€§

3. **å®¢æˆ·ç«¯é‡å®šå‘**
   - MOVEDï¼šæ°¸ä¹…é‡å®šå‘
   - ASKï¼šä¸´æ—¶é‡å®šå‘

4. **æ•…éšœè½¬ç§»**
   - è‡ªåŠ¨æ£€æµ‹æ•…éšœ
   - ä»èŠ‚ç‚¹è‡ªåŠ¨æå‡
   - é€‰ä¸¾æœºåˆ¶

5. **æ‰©å®¹ç¼©å®¹**
   - åŠ¨æ€æ·»åŠ /åˆ é™¤èŠ‚ç‚¹
   - æ§½ä½åœ¨çº¿è¿ç§»

6. **æœ€ä½³å®è·µ**
   - æœ€å°‘6èŠ‚ç‚¹ï¼ˆ3ä¸»3ä»ï¼‰
   - å¥‡æ•°ä¸ªä¸»èŠ‚ç‚¹
   - ä½¿ç”¨å“ˆå¸Œæ ‡ç­¾

### ç¬¬äºŒé˜¶æ®µå®Œæˆæ€»ç»“

ğŸ‰ **æ­å–œï¼æ¶æ„åŸç†ç¯‡ï¼ˆ10ç¯‡æ–‡ç« ï¼‰å…¨éƒ¨å®Œæˆï¼**

**å·²æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†**ï¼š
1. Rediså¯¹è±¡ç³»ç»Ÿä¸å†…å­˜æ¨¡å‹
2. SDSã€è·³è¡¨ã€å­—å…¸ã€intsetã€zipliståº•å±‚æ•°æ®ç»“æ„
3. å•çº¿ç¨‹æ¨¡å‹ä¸IOå¤šè·¯å¤ç”¨
4. ä¸»ä»å¤åˆ¶ã€å“¨å…µã€Clusteré«˜å¯ç”¨æ¶æ„

**ä¸‹ä¸€é˜¶æ®µé¢„å‘Š**ï¼š
ç¬¬ä¸‰é˜¶æ®µã€Šè¿›é˜¶ç‰¹æ€§ç¯‡ã€‹å°†æ·±å…¥ï¼š
- Luaè„šæœ¬ç¼–ç¨‹
- Bitmapã€HyperLogLogã€GEOã€Streamé«˜çº§æ•°æ®ç±»å‹
- åˆ†å¸ƒå¼é”ã€å¸ƒéš†è¿‡æ»¤å™¨
- å»¶è¿Ÿé˜Ÿåˆ—ã€é™æµç®—æ³•

æœŸå¾…ç»§ç»­å­¦ä¹ ï¼
