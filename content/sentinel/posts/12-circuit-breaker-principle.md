---
title: "ç†”æ–­é™çº§åŸç†ï¼šæ–­è‡‚æ±‚ç”Ÿçš„è‰ºæœ¯"
date: 2025-11-21T15:30:00+08:00
draft: false
tags: ["Sentinel", "ç†”æ–­é™çº§", "ç†”æ–­å™¨", "æœåŠ¡ä¿æŠ¤"]
categories: ["æŠ€æœ¯"]
series: ["Sentinelä»å…¥é—¨åˆ°ç²¾é€š"]
weight: 12
stage: 3
stageTitle: "ç†”æ–­é™çº§ç¯‡"
description: "ç†è§£ç†”æ–­é™çº§çš„æœ¬è´¨å’ŒåŸç†ï¼Œå­¦ä¹ å¦‚ä½•ä¿æŠ¤ç³»ç»Ÿå…å—æ•…éšœä¼ æ’­"
---

## å¼•è¨€ï¼šå½“æœåŠ¡"ç”Ÿç—…"æ—¶

è¿˜è®°å¾—æˆ‘ä»¬åœ¨å‰é¢å­¦è¿‡çš„é™æµå—ï¼Ÿé™æµæ˜¯å¯¹**æµé‡çš„ä¸»åŠ¨é˜²å¾¡**â€”â€”å°±åƒæ™¯åŒºè®¾ç½®çš„æ—¥æ¥å¾…é‡ä¸Šé™ï¼Œäººæ»¡äº†å°±ä¸è®©è¿›ã€‚

ä½†åœ¨å¾®æœåŠ¡ä¸–ç•Œé‡Œï¼Œé™¤äº†æµé‡æ´ªå³°ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªæ›´éšè”½çš„å¨èƒï¼š**ä¾èµ–æœåŠ¡çš„æ•…éšœä¼ æ’­**ã€‚

æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š

> ä½ çš„è®¢å•æœåŠ¡ä¾èµ–å•†å“æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯ã€‚æŸå¤©å‡Œæ™¨ï¼Œå•†å“æœåŠ¡çš„æ•°æ®åº“å‡ºç°äº†æ…¢æŸ¥è¯¢é—®é¢˜ï¼Œå¯¼è‡´å•†å“æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ä»10msé£™å‡åˆ°5ç§’ã€‚
>
> è®¢å•æœåŠ¡ä¸çŸ¥æƒ…ï¼Œç»§ç»­è°ƒç”¨å•†å“æœåŠ¡ã€‚æ¯æ¬¡è°ƒç”¨éƒ½è¦ç­‰5ç§’æ‰è¶…æ—¶ã€‚å¤§é‡è¯·æ±‚çº¿ç¨‹è¢«é˜»å¡ï¼Œçº¿ç¨‹æ± å¾ˆå¿«è¢«è€—å°½ã€‚
>
> äºæ˜¯ï¼Œè®¢å•æœåŠ¡ä¹Ÿ"æŒ‚äº†"ã€‚æ¥ç€ï¼Œä¾èµ–è®¢å•æœåŠ¡çš„è´­ç‰©è½¦æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ä¹Ÿæ¥è¿å´©æºƒ...
>
> **ä¸€åœºé›ªå´©å°±è¿™æ ·å‘ç”Ÿäº†ã€‚**

è¿™å°±æ˜¯å¾®æœåŠ¡æ¶æ„çš„**é˜¿å–€ç‰æ–¯ä¹‹è¸µ**ï¼šæ•…éšœä¼šæ²¿ç€è°ƒç”¨é“¾ä¼ æ’­ï¼Œä¸€ä¸ªæœåŠ¡çš„é—®é¢˜å¯èƒ½å¯¼è‡´æ•´ä¸ªç³»ç»Ÿç˜«ç—ªã€‚

**ç†”æ–­é™çº§**å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œç”Ÿçš„ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

> **å½“ä¾èµ–æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œä¸»åŠ¨"æ–­å¼€"å¯¹å®ƒçš„è°ƒç”¨ï¼Œé¿å…æ•…éšœä¼ æ’­ã€‚å°±åƒå£®å£«æ–­è…•ï¼Œç‰ºç‰²å±€éƒ¨ï¼Œä¿å…¨æ•´ä½“ã€‚**

è¿™å°±æ˜¯"æ–­è‡‚æ±‚ç”Ÿçš„è‰ºæœ¯"ã€‚

---

## ç†”æ–­çš„æœ¬è´¨ï¼šé˜²æ­¢æ•…éšœè”“å»¶

### ä»€ä¹ˆæ˜¯ç†”æ–­ï¼Ÿ

ç†”æ–­ï¼ˆCircuit Breakingï¼‰çš„æœ¬è´¨æ˜¯**æ•…éšœéš”ç¦»æœºåˆ¶**ã€‚

å½“ç³»ç»Ÿæ£€æµ‹åˆ°æŸä¸ªä¾èµ–æœåŠ¡å‡ºç°å¼‚å¸¸ï¼ˆå¦‚å“åº”è¶…æ—¶ã€å¼‚å¸¸ç‡è¿‡é«˜ï¼‰ï¼Œå°±ä¸»åŠ¨åˆ‡æ–­å¯¹è¯¥æœåŠ¡çš„è°ƒç”¨ï¼Œå¿«é€Ÿè¿”å›ä¸€ä¸ª"é™çº§ç»“æœ"ï¼ˆå¦‚é»˜è®¤å€¼ã€ç¼“å­˜æ•°æ®ã€å‹å¥½æç¤ºï¼‰ï¼Œé¿å…è°ƒç”¨æ–¹çº¿ç¨‹è¢«é•¿æ—¶é—´é˜»å¡ã€‚

**ç†”æ–­çš„ä¸‰ä¸ªå…³é”®è¦ç´ **ï¼š

1. **æ•…éšœæ£€æµ‹**ï¼šæŒç»­ç›‘æ§ä¾èµ–æœåŠ¡çš„å¥åº·çŠ¶å†µ
2. **å¿«é€Ÿå¤±è´¥**ï¼šæ£€æµ‹åˆ°æ•…éšœåï¼Œå¿«é€Ÿè¿”å›è€Œä¸æ˜¯ç»§ç»­ç­‰å¾…
3. **è‡ªåŠ¨æ¢å¤**ï¼šæ•…éšœæ¢å¤åï¼Œè‡ªåŠ¨æ¢å¤æ­£å¸¸è°ƒç”¨

### ä¸ºä»€ä¹ˆéœ€è¦ç†”æ–­ï¼Ÿ

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œè°ƒç”¨ç›¸äº’ä¾èµ–ï¼Œå½¢æˆäº†å¤æ‚çš„è°ƒç”¨é“¾è·¯ã€‚è¿™ç§æ¶æ„æœ‰ä¸€ä¸ªå¤©ç„¶çš„è„†å¼±æ€§ï¼š

**å•ä¸ªæœåŠ¡çš„æ•…éšœä¼šè¿…é€Ÿæ‰©æ•£ï¼Œå¯¼è‡´é›ªå´©æ•ˆåº”ã€‚**

ä¸¾ä¸ªä¾‹å­ï¼š

```
ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ å•†å“æœåŠ¡ â†’ åº“å­˜æœåŠ¡
              â†“
            æ”¯ä»˜æœåŠ¡
```

å¦‚æœåº“å­˜æœåŠ¡å‡ºç°æ•…éšœï¼ˆå¦‚æ•°æ®åº“æ…¢æŸ¥è¯¢ï¼‰ï¼Œä¼šå‘ç”Ÿï¼š

1. **åº“å­˜æœåŠ¡**ï¼šå“åº”å˜æ…¢ï¼Œæ¯ä¸ªè¯·æ±‚è€—æ—¶5ç§’
2. **å•†å“æœåŠ¡**ï¼šè°ƒç”¨åº“å­˜æœåŠ¡è¢«é˜»å¡ï¼Œçº¿ç¨‹æ± å æ»¡
3. **è®¢å•æœåŠ¡**ï¼šè°ƒç”¨å•†å“æœåŠ¡è¶…æ—¶ï¼Œè‡ªå·±çš„çº¿ç¨‹æ± ä¹Ÿè¢«å æ»¡
4. **ç”¨æˆ·æœåŠ¡**ï¼šè°ƒç”¨è®¢å•æœåŠ¡å¤±è´¥ï¼Œæ— æ³•æä¾›æœåŠ¡
5. **æ•´ä¸ªç³»ç»Ÿ**ï¼šå› ä¸ºä¸€ä¸ªå°é—®é¢˜è€Œå…¨é¢ç˜«ç—ª

**ç†”æ–­çš„ä½œç”¨å°±æ˜¯åˆ‡æ–­è¿™æ¡ä¼ æ’­é“¾**ï¼š

- å•†å“æœåŠ¡æ£€æµ‹åˆ°åº“å­˜æœåŠ¡æ•…éšœï¼Œç†”æ–­å¯¹åº“å­˜æœåŠ¡çš„è°ƒç”¨
- å•†å“æœåŠ¡è¿”å›é™çº§ç»“æœï¼ˆå¦‚æ˜¾ç¤º"æš‚æ—¶æ— æ³•æŸ¥è¯¢åº“å­˜"ï¼‰
- å•†å“æœåŠ¡è‡ªèº«ä¿æŒæ­£å¸¸è¿è¡Œ
- è®¢å•æœåŠ¡ã€ç”¨æˆ·æœåŠ¡ä¸å—å½±å“

---

## ç±»æ¯”ï¼šå®¶ç”¨ç”µè·¯ç†”æ–­å™¨

ç†”æ–­ï¼ˆCircuit Breakerï¼‰è¿™ä¸ªåå­—æ¥æºäºæˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­çš„**ç”µè·¯ç†”æ–­å™¨**ã€‚

### ç”µè·¯ç†”æ–­å™¨çš„å·¥ä½œåŸç†

æƒ³è±¡ä½ å®¶çš„é…ç”µç®±ï¼š

1. **æ­£å¸¸å·¥ä½œ**ï¼šç”µæµæ­£å¸¸ï¼Œç†”æ–­å™¨ä¿æŒé—­åˆï¼Œç”µè·¯æ­£å¸¸ä¾›ç”µ
2. **è¿‡è½½ä¿æŠ¤**ï¼šå½“ç”µæµè¿‡å¤§ï¼ˆå¦‚åŒæ—¶å¼€å¤ªå¤šç”µå™¨ï¼‰ï¼Œç†”æ–­å™¨æ£€æµ‹åˆ°å¼‚å¸¸
3. **è‡ªåŠ¨æ–­å¼€**ï¼šç†”æ–­å™¨ç«‹å³è·³é—¸ï¼Œåˆ‡æ–­ç”µè·¯ï¼Œé¿å…ç”µçº¿è¿‡çƒ­å¼•å‘ç«ç¾
4. **æ‰‹åŠ¨æ¢å¤**ï¼šæ’é™¤æ•…éšœåï¼Œå¯ä»¥æ‰‹åŠ¨åˆä¸Šå¼€å…³ï¼Œæ¢å¤ä¾›ç”µ

è½¯ä»¶ä¸­çš„ç†”æ–­å™¨å·¥ä½œåŸç†å®Œå…¨ä¸€æ ·ï¼š

| ç”µè·¯ç†”æ–­å™¨ | è½¯ä»¶ç†”æ–­å™¨ |
|---------|---------|
| ç”µæµè¿‡å¤§ | æœåŠ¡å“åº”æ…¢/å¼‚å¸¸å¤š |
| è‡ªåŠ¨æ–­å¼€ç”µè·¯ | åœæ­¢è°ƒç”¨æœåŠ¡ |
| é¿å…ç«ç¾ | é˜²æ­¢çº¿ç¨‹è€—å°½ |
| æ‰‹åŠ¨åˆé—¸ | è‡ªåŠ¨å°è¯•æ¢å¤ |

---

## ç†”æ–­å™¨çŠ¶æ€æœºï¼šä¸‰ç§çŠ¶æ€

Sentinelçš„ç†”æ–­å™¨æ˜¯ä¸€ä¸ª**æœ‰çŠ¶æ€çš„å¯¹è±¡**ï¼Œå®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼š

### 1. å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰

è¿™æ˜¯ç†”æ–­å™¨çš„**åˆå§‹çŠ¶æ€**å’Œ**æ­£å¸¸å·¥ä½œçŠ¶æ€**ã€‚

**ç‰¹å¾**ï¼š
- æ‰€æœ‰è¯·æ±‚æ­£å¸¸é€šè¿‡ï¼Œè°ƒç”¨ä¾èµ–æœåŠ¡
- æŒç»­ç›‘æ§è°ƒç”¨çš„å¥åº·æŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€å¼‚å¸¸æ¯”ä¾‹ï¼‰
- å¦‚æœæŒ‡æ ‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ‡æ¢åˆ°"å¼€å¯"çŠ¶æ€

**è§¦å‘æ¡ä»¶**ï¼š
- ç³»ç»Ÿåˆšå¯åŠ¨æ—¶
- ä»"åŠå¼€"çŠ¶æ€æ¢å¤å

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Closedï¼ˆå…³é—­ï¼‰  â”‚  â† åˆå§‹çŠ¶æ€
â”‚  æ­£å¸¸è°ƒç”¨æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    æŒ‡æ ‡å¼‚å¸¸
        â†“
```

### 2. å¼€å¯çŠ¶æ€ï¼ˆOpenï¼‰

è¿™æ˜¯ç†”æ–­å™¨çš„**ä¿æŠ¤çŠ¶æ€**ã€‚

**ç‰¹å¾**ï¼š
- **ä¸å†è°ƒç”¨ä¾èµ–æœåŠ¡**ï¼Œç›´æ¥å¿«é€Ÿå¤±è´¥
- è¿”å›é™çº§ç»“æœï¼ˆå¦‚é»˜è®¤å€¼ã€ç¼“å­˜æ•°æ®ï¼‰
- è®¾ç½®ä¸€ä¸ªæ¢å¤æ—¶é—´çª—å£ï¼ˆå¦‚10ç§’ï¼‰
- æ—¶é—´çª—å£åˆ°æœŸåï¼Œåˆ‡æ¢åˆ°"åŠå¼€"çŠ¶æ€

**è§¦å‘æ¡ä»¶**ï¼š
- æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼
- å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼
- å¼‚å¸¸æ•°è¶…è¿‡é˜ˆå€¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Openï¼ˆå¼€å¯ï¼‰    â”‚
â”‚  å¿«é€Ÿå¤±è´¥       â”‚
â”‚  è¿”å›é™çº§ç»“æœ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    ç­‰å¾…æ—¶é—´çª—å£
        â†“
```

### 3. åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰

è¿™æ˜¯ç†”æ–­å™¨çš„**æ¢æµ‹çŠ¶æ€**ã€‚

**ç‰¹å¾**ï¼š
- å…è®¸**ä¸€ä¸ª**è¯·æ±‚é€šè¿‡ï¼Œè¯•æ¢æ€§åœ°è°ƒç”¨ä¾èµ–æœåŠ¡
- å¦‚æœè¿™ä¸ªè¯·æ±‚æˆåŠŸï¼Œè¯´æ˜æœåŠ¡æ¢å¤äº†ï¼Œåˆ‡æ¢å›"å…³é—­"çŠ¶æ€
- å¦‚æœè¿™ä¸ªè¯·æ±‚å¤±è´¥ï¼Œè¯´æ˜æœåŠ¡è¿˜æ²¡æ¢å¤ï¼Œåˆ‡æ¢å›"å¼€å¯"çŠ¶æ€

**è§¦å‘æ¡ä»¶**ï¼š
- ä»"å¼€å¯"çŠ¶æ€çš„æ¢å¤æ—¶é—´çª—å£åˆ°æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Half-Openï¼ˆåŠå¼€ï¼‰â”‚
â”‚ è¯•æ¢æ€§è°ƒç”¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
     è°ƒç”¨æˆåŠŸï¼Ÿ
    â†™      â†˜
  æ˜¯         å¦
  â†“          â†“
Closed     Open
```

### å®Œæ•´çš„çŠ¶æ€æœºæµç¨‹

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚
         â†“                                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   æ•…éšœæ£€æµ‹    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚ Closed  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚   Open   â”‚   â”‚
    â”‚ (å…³é—­)  â”‚              â”‚  (å¼€å¯)  â”‚   â”‚
    â”‚æ­£å¸¸è°ƒç”¨  â”‚              â”‚å¿«é€Ÿå¤±è´¥   â”‚   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â†‘                        â†“          â”‚
         â”‚                    ç­‰å¾…æ—¶é—´çª—å£     â”‚
         â”‚                        â†“          â”‚
         â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚     è°ƒç”¨æˆåŠŸ       â”‚Half-Open â”‚   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  (åŠå¼€)  â”‚   â”‚
                             â”‚è¯•æ¢è°ƒç”¨   â”‚   â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                   â”‚         â”‚
                                è°ƒç”¨å¤±è´¥      â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç†”æ–­ vs é™æµï¼šä¸¤ç§ä¿æŠ¤æœºåˆ¶çš„å¯¹æ¯”

å¾ˆå¤šåˆå­¦è€…ä¼šæ··æ·†ç†”æ–­å’Œé™æµï¼Œå®ƒä»¬éƒ½æ˜¯ç³»ç»Ÿä¿æŠ¤æœºåˆ¶ï¼Œä½†**ä¿æŠ¤çš„å¯¹è±¡å’Œè§¦å‘æ¡ä»¶å®Œå…¨ä¸åŒ**ã€‚

### æ ¸å¿ƒåŒºåˆ«

| ç»´åº¦ | é™æµï¼ˆFlow Controlï¼‰ | ç†”æ–­ï¼ˆCircuit Breakingï¼‰ |
|-----|---------------------|------------------------|
| **ä¿æŠ¤å¯¹è±¡** | ä¿æŠ¤**è‡ªå·±**ä¸è¢«æµé‡å‹å® | ä¿æŠ¤**è‡ªå·±**ä¸è¢«ä¾èµ–æœåŠ¡æ‹–å® |
| **è§¦å‘æ¡ä»¶** | æµé‡è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚QPS > 1000ï¼‰ | ä¾èµ–æœåŠ¡æ•…éšœï¼ˆå¦‚å“åº”æ…¢ã€å¼‚å¸¸å¤šï¼‰ |
| **å¤„ç†æ–¹å¼** | æ‹’ç»æ–°è¯·æ±‚ | åœæ­¢è°ƒç”¨ä¾èµ–æœåŠ¡ |
| **æ¢å¤æœºåˆ¶** | æµé‡é™ä½åè‡ªç„¶æ¢å¤ | è‡ªåŠ¨æ¢æµ‹æœåŠ¡æ¢å¤ |
| **é€‚ç”¨åœºæ™¯** | å¤§ä¿ƒã€ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ | å¾®æœåŠ¡è°ƒç”¨ã€å¤–éƒ¨ä¾èµ–åœºæ™¯ |

### å½¢è±¡çš„ç±»æ¯”

**é™æµ**ï¼šå°±åƒæ™¯åŒºçš„é™æµæªæ–½
- æ™¯åŒºæœ‰æ‰¿è½½èƒ½åŠ›ä¸Šé™ï¼ˆèµ„æºæœ‰é™ï¼‰
- æ¸¸å®¢å¤ªå¤šä¼šå¯¼è‡´ä½“éªŒå·®ç”šè‡³è¸©è¸äº‹æ•…
- è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®æ—¥æ¥å¾…é‡ä¸Šé™ï¼Œäººæ»¡ä¸è®©è¿›

**ç†”æ–­**ï¼šå°±åƒé˜²ç«å¢™çš„éš”ç¦»æªæ–½
- ä¸€ä¸ªæˆ¿é—´ç€ç«äº†ï¼ˆä¾èµ–æœåŠ¡æ•…éšœï¼‰
- ç«åŠ¿å¯èƒ½è”“å»¶åˆ°å…¶ä»–æˆ¿é—´ï¼ˆæ•…éšœä¼ æ’­ï¼‰
- è§£å†³æ–¹æ¡ˆï¼šå…³é—­é˜²ç«é—¨ï¼Œéš”ç¦»æ•…éšœåŒºåŸŸ

### å®æˆ˜æ¡ˆä¾‹å¯¹æ¯”

**é™æµåœºæ™¯**ï¼š

```java
@SentinelResource(value = "seckill", blockHandler = "seckillBlockHandler")
public String seckill() {
    // ç§’æ€é€»è¾‘
    return "æŠ¢è´­æˆåŠŸ";
}

// é™æµè§„åˆ™ï¼šQPSä¸è¶…è¿‡5000
FlowRule rule = new FlowRule();
rule.setResource("seckill");
rule.setCount(5000);
```

**ç†”æ–­åœºæ™¯**ï¼š

```java
@SentinelResource(value = "callInventory", fallback = "inventoryFallback")
public InventoryInfo callInventory(Long productId) {
    // è°ƒç”¨åº“å­˜æœåŠ¡
    return inventoryService.getInventory(productId);
}

// ç†”æ–­è§„åˆ™ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡50%åˆ™ç†”æ–­
DegradeRule rule = new DegradeRule();
rule.setResource("callInventory");
rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
rule.setCount(1000); // å“åº”æ—¶é—´è¶…è¿‡1ç§’ç®—æ…¢è°ƒç”¨
rule.setSlowRatioThreshold(0.5); // æ…¢è°ƒç”¨æ¯”ä¾‹
```

### ç»„åˆä½¿ç”¨

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œ**é™æµå’Œç†”æ–­é€šå¸¸ç»„åˆä½¿ç”¨**ï¼š

```
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   ç½‘å…³å±‚     â”‚
                 â”‚  é™æµä¿æŠ¤    â”‚  â† é˜²æ­¢æµé‡æ´ªå³°
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  è®¢å•æœåŠ¡    â”‚
                 â”‚  é™æµä¿æŠ¤    â”‚  â† ä¿æŠ¤è‡ªå·±çš„æ¥å£
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  è°ƒç”¨å•†å“æœåŠ¡ â”‚
                 â”‚  ç†”æ–­ä¿æŠ¤    â”‚  â† é˜²æ­¢ä¾èµ–æœåŠ¡æ‹–å®è‡ªå·±
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Sentinelçš„ç†”æ–­å®ç°

Sentinelæä¾›äº†**ä¸‰ç§ç†”æ–­ç­–ç•¥**ï¼š

### 1. æ…¢è°ƒç”¨æ¯”ä¾‹ï¼ˆDEGRADE_GRADE_RTï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- è¯·æ±‚å“åº”æ—¶é—´ï¼ˆRTï¼‰è¶…è¿‡é˜ˆå€¼çš„æ¯”ä¾‹è¶…è¿‡è®¾å®šå€¼
- ä¾‹å¦‚ï¼šRT > 1ç§’çš„è¯·æ±‚å æ¯” > 50%

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¾èµ–æœåŠ¡å“åº”å˜æ…¢
- æ•°æ®åº“æ…¢æŸ¥è¯¢
- ç½‘ç»œæŠ–åŠ¨

```java
DegradeRule rule = new DegradeRule();
rule.setResource("callRemoteService");
rule.setGrade(RuleConstant.DEGRADE_GRADE_RT); // æ…¢è°ƒç”¨æ¯”ä¾‹ç­–ç•¥
rule.setCount(1000); // å“åº”æ—¶é—´è¶…è¿‡1000msç®—æ…¢è°ƒç”¨
rule.setSlowRatioThreshold(0.5); // æ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼50%
rule.setMinRequestAmount(5); // æœ€å°è¯·æ±‚æ•°
rule.setStatIntervalMs(10000); // ç»Ÿè®¡æ—¶é•¿10ç§’
rule.setTimeWindow(10); // ç†”æ–­æ—¶é•¿10ç§’
```

### 2. å¼‚å¸¸æ¯”ä¾‹ï¼ˆDEGRADE_GRADE_EXCEPTION_RATIOï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- å¼‚å¸¸è¯·æ±‚å æ€»è¯·æ±‚çš„æ¯”ä¾‹è¶…è¿‡é˜ˆå€¼
- ä¾‹å¦‚ï¼šå¼‚å¸¸ç‡ > 30%

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¾èµ–æœåŠ¡é¢‘ç¹æŠ›å¼‚å¸¸
- ç½‘ç»œè¿æ¥å¤±è´¥
- ç¬¬ä¸‰æ–¹APIä¸ç¨³å®š

```java
DegradeRule rule = new DegradeRule();
rule.setResource("callThirdPartyApi");
rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO); // å¼‚å¸¸æ¯”ä¾‹ç­–ç•¥
rule.setCount(0.3); // å¼‚å¸¸æ¯”ä¾‹é˜ˆå€¼30%
rule.setMinRequestAmount(5);
rule.setStatIntervalMs(10000);
rule.setTimeWindow(10);
```

### 3. å¼‚å¸¸æ•°ï¼ˆDEGRADE_GRADE_EXCEPTION_COUNTï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- åœ¨ç»Ÿè®¡æ—¶é•¿å†…ï¼Œå¼‚å¸¸æ•°è¶…è¿‡é˜ˆå€¼
- ä¾‹å¦‚ï¼š10ç§’å†…å¼‚å¸¸æ•° > 10

**é€‚ç”¨åœºæ™¯**ï¼š
- ä½æµé‡æ¥å£
- å¯¹å¼‚å¸¸éå¸¸æ•æ„Ÿçš„åœºæ™¯

```java
DegradeRule rule = new DegradeRule();
rule.setResource("callPaymentApi");
rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT); // å¼‚å¸¸æ•°ç­–ç•¥
rule.setCount(10); // å¼‚å¸¸æ•°é˜ˆå€¼10æ¬¡
rule.setMinRequestAmount(5);
rule.setStatIntervalMs(10000);
rule.setTimeWindow(10);
```

---

## ä»€ä¹ˆæ—¶å€™éœ€è¦ç†”æ–­ï¼Ÿ

ç†”æ–­ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œéœ€è¦åœ¨**åˆé€‚çš„åœºæ™¯**ä½¿ç”¨ã€‚

### é€‚åˆä½¿ç”¨ç†”æ–­çš„åœºæ™¯

1. **è°ƒç”¨å¤–éƒ¨ä¾èµ–**
   - ç¬¬ä¸‰æ–¹APIï¼ˆå¦‚æ”¯ä»˜ã€ç‰©æµã€çŸ­ä¿¡ï¼‰
   - å…¶ä»–å›¢é˜Ÿç»´æŠ¤çš„æœåŠ¡
   - ä¸å—è‡ªå·±æ§åˆ¶çš„æœåŠ¡

2. **ä¸ç¨³å®šçš„æœåŠ¡**
   - ç»å¸¸å‡ºç°æ…¢æŸ¥è¯¢
   - å¶å°”ä¼šæŠ›å¼‚å¸¸
   - èµ„æºç´§å¼ çš„æœåŠ¡

3. **éæ ¸å¿ƒåŠŸèƒ½**
   - æ¨èæœåŠ¡ï¼ˆå¯ä»¥é™çº§ä¸ºä¸æ¨èï¼‰
   - è¯„è®ºæœåŠ¡ï¼ˆå¯ä»¥æš‚æ—¶ä¸æ˜¾ç¤ºï¼‰
   - ç§¯åˆ†æœåŠ¡ï¼ˆå¯ä»¥å¼‚æ­¥è¡¥å¿ï¼‰

### ä¸é€‚åˆä½¿ç”¨ç†”æ–­çš„åœºæ™¯

1. **æ ¸å¿ƒä¸šåŠ¡æµç¨‹**
   - è®¢å•åˆ›å»ºï¼ˆä¸èƒ½é™çº§ï¼‰
   - æ”¯ä»˜æ‰£æ¬¾ï¼ˆä¸èƒ½é™çº§ï¼‰
   - ç”¨æˆ·ç™»å½•ï¼ˆä¸èƒ½é™çº§ï¼‰

2. **å¼ºä¸€è‡´æ€§è¦æ±‚**
   - åº“å­˜æ‰£å‡ï¼ˆå¿…é¡»ç²¾ç¡®ï¼‰
   - è´¦æˆ·ä½™é¢ï¼ˆä¸èƒ½æœ‰è¯¯å·®ï¼‰
   - é‡‘èäº¤æ˜“ï¼ˆä¸å…è®¸é™çº§ï¼‰

3. **å†…éƒ¨å¯æ§çš„è°ƒç”¨**
   - åŒä¸€è¿›ç¨‹å†…çš„æ–¹æ³•è°ƒç”¨
   - æœ¬åœ°ç¼“å­˜æŸ¥è¯¢
   - å†…å­˜è®¡ç®—

### å†³ç­–æ ‘

```
æ˜¯å¦éœ€è¦ç†”æ–­ï¼Ÿ
    â†“
æ˜¯å¦è°ƒç”¨å¤–éƒ¨ä¾èµ–ï¼Ÿ
    â”œâ”€ å¦ â†’ ä¸éœ€è¦ç†”æ–­
    â””â”€ æ˜¯ â†“
       ä¾èµ–æœåŠ¡æ˜¯å¦ç¨³å®šï¼Ÿ
           â”œâ”€ ç¨³å®š â†’ å¯ä»¥ä¸ç†”æ–­ï¼Œä½†å»ºè®®é…ç½®
           â””â”€ ä¸ç¨³å®š â†“
              æ˜¯å¦æ ¸å¿ƒä¸šåŠ¡ï¼Ÿ
                  â”œâ”€ æ˜¯ â†’ éœ€è¦ç†”æ–­ + ç²¾å¿ƒè®¾è®¡é™çº§æ–¹æ¡ˆ
                  â””â”€ å¦ â†’ å¿…é¡»ç†”æ–­
```

---

## å®æˆ˜æ¼”ç¤ºï¼šæœ€ç®€å•çš„ç†”æ–­æ¡ˆä¾‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½“éªŒç†”æ–­çš„æ•ˆæœã€‚

### åœºæ™¯

æ¨¡æ‹Ÿè°ƒç”¨ä¸€ä¸ª**ä¸ç¨³å®šçš„å•†å“æœåŠ¡**ï¼š
- æ­£å¸¸å“åº”æ—¶é—´ï¼š50ms
- æ•…éšœæ—¶å“åº”æ—¶é—´ï¼š3ç§’
- æˆ‘ä»¬è®¾ç½®ç†”æ–­è§„åˆ™ï¼šRT > 1ç§’çš„è¯·æ±‚å æ¯” > 50% åˆ™ç†”æ–­

### å®Œæ•´ä»£ç 

```java
import com.alibaba.csp.sentinel.Entry;
import com.alibaba.csp.sentinel.SphU;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.csp.sentinel.slots.block.RuleConstant;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;
import com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;

import java.util.ArrayList;
import java.util.List;

public class CircuitBreakerDemo {

    public static void main(String[] args) throws InterruptedException {
        // 1. é…ç½®ç†”æ–­è§„åˆ™
        initDegradeRule();

        // 2. æ¨¡æ‹Ÿè°ƒç”¨
        for (int i = 0; i < 20; i++) {
            Thread.sleep(500);
            callProductService(i < 10); // å‰10æ¬¡æ­£å¸¸ï¼Œå10æ¬¡æ•…éšœ
        }
    }

    /**
     * é…ç½®ç†”æ–­è§„åˆ™
     */
    private static void initDegradeRule() {
        List<DegradeRule> rules = new ArrayList<>();
        DegradeRule rule = new DegradeRule();
        rule.setResource("callProductService");
        rule.setGrade(RuleConstant.DEGRADE_GRADE_RT); // æ…¢è°ƒç”¨æ¯”ä¾‹
        rule.setCount(1000); // RTè¶…è¿‡1000msç®—æ…¢è°ƒç”¨
        rule.setSlowRatioThreshold(0.5); // æ…¢è°ƒç”¨æ¯”ä¾‹50%
        rule.setMinRequestAmount(5); // æœ€å°‘5ä¸ªè¯·æ±‚
        rule.setStatIntervalMs(10000); // ç»Ÿè®¡æ—¶é•¿10ç§’
        rule.setTimeWindow(10); // ç†”æ–­10ç§’
        rules.add(rule);
        DegradeRuleManager.loadRules(rules);
        System.out.println("âœ… ç†”æ–­è§„åˆ™å·²åŠ è½½");
    }

    /**
     * è°ƒç”¨å•†å“æœåŠ¡
     */
    private static void callProductService(boolean isNormal) {
        try (Entry entry = SphU.entry("callProductService")) {
            // æ¨¡æ‹Ÿè°ƒç”¨å•†å“æœåŠ¡
            if (isNormal) {
                Thread.sleep(50); // æ­£å¸¸å“åº”50ms
                System.out.println("âœ… è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š50ms");
            } else {
                Thread.sleep(3000); // æ•…éšœæ—¶å“åº”3ç§’
                System.out.println("âš ï¸  è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š3000msï¼ˆæ…¢è°ƒç”¨ï¼‰");
            }
        } catch (BlockException e) {
            // ç†”æ–­é™çº§
            System.out.println("ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

### è¿è¡Œæ•ˆæœ

```
âœ… ç†”æ–­è§„åˆ™å·²åŠ è½½
âœ… è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š50ms
âœ… è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š50ms
âœ… è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š50ms
âœ… è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š50ms
âœ… è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š50ms
âš ï¸  è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š3000msï¼ˆæ…¢è°ƒç”¨ï¼‰
âš ï¸  è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š3000msï¼ˆæ…¢è°ƒç”¨ï¼‰
âš ï¸  è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š3000msï¼ˆæ…¢è°ƒç”¨ï¼‰
âš ï¸  è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š3000msï¼ˆæ…¢è°ƒç”¨ï¼‰
âš ï¸  è°ƒç”¨æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š3000msï¼ˆæ…¢è°ƒç”¨ï¼‰
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ  â† ç†”æ–­å™¨å¼€å¯
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
ğŸ”´ ç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§ç»“æœ
```

### æ•ˆæœåˆ†æ

1. **å‰5æ¬¡**ï¼šæ­£å¸¸è°ƒç”¨ï¼Œå“åº”æ—¶é—´50ms
2. **ç¬¬6-10æ¬¡**ï¼šæ¨¡æ‹Ÿæ•…éšœï¼Œå“åº”æ—¶é—´3000msï¼ˆæ…¢è°ƒç”¨ï¼‰
3. **ç¬¬11æ¬¡**ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹è¾¾åˆ°50%ï¼ˆ5/10ï¼‰ï¼Œ**ç†”æ–­å™¨å¼€å¯**
4. **ç¬¬11-20æ¬¡**ï¼šç†”æ–­ç”Ÿæ•ˆï¼Œå¿«é€Ÿå¤±è´¥ï¼Œä¸å†è°ƒç”¨æœåŠ¡

**å…³é”®æ”¶ç›Š**ï¼š
- **é¿å…çº¿ç¨‹é˜»å¡**ï¼šå¦‚æœä¸ç†”æ–­ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦ç­‰3ç§’
- **å¿«é€Ÿå¤±è´¥**ï¼šç†”æ–­åç›´æ¥è¿”å›ï¼Œå“åº”æ—¶é—´ä»3ç§’é™åˆ°1ms
- **ä¿æŠ¤ç³»ç»Ÿ**ï¼šè°ƒç”¨æ–¹ä¸ä¼šå› ä¸ºä¾èµ–æœåŠ¡æ…¢è€Œè¢«æ‹–å®

---

## æ€»ç»“

æœ¬æ–‡æˆ‘ä»¬å­¦ä¹ äº†ç†”æ–­é™çº§çš„æ ¸å¿ƒåŸç†ï¼š

1. **ç†”æ–­çš„æœ¬è´¨**ï¼šé˜²æ­¢æ•…éšœåœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯ä¸­ä¼ æ’­
2. **ç†”æ–­å™¨çŠ¶æ€æœº**ï¼šå…³é—­ã€å¼€å¯ã€åŠå¼€ä¸‰ç§çŠ¶æ€
3. **ç†”æ–­ vs é™æµ**ï¼šä¿æŠ¤è‡ªå·±ä¸è¢«ä¾èµ–æœåŠ¡æ‹–å® vs ä¿æŠ¤è‡ªå·±ä¸è¢«æµé‡å‹å®
4. **Sentinelçš„ç†”æ–­ç­–ç•¥**ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°
5. **ä½¿ç”¨åœºæ™¯**ï¼šè°ƒç”¨å¤–éƒ¨ä¾èµ–ã€ä¸ç¨³å®šçš„æœåŠ¡ã€éæ ¸å¿ƒåŠŸèƒ½

**æ ¸å¿ƒè¦ç‚¹**ï¼š

> ç†”æ–­æ˜¯ä¸€ç§"æ–­è‡‚æ±‚ç”Ÿ"çš„ç­–ç•¥ï¼Œé€šè¿‡ä¸»åŠ¨åˆ‡æ–­å¯¹æ•…éšœæœåŠ¡çš„è°ƒç”¨ï¼Œé¿å…æ•…éšœæ‰©æ•£ï¼Œä¿æŠ¤æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

**ä¸‹ä¸€ç¯‡é¢„å‘Š**ï¼š

æˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ **ä¸‰ç§ç†”æ–­ç­–ç•¥çš„è§¦å‘æ¡ä»¶å’Œé…ç½®æ–¹æ³•**ï¼š
- æ…¢è°ƒç”¨æ¯”ä¾‹ï¼šå¦‚ä½•ç•Œå®š"æ…¢"ï¼Ÿé˜ˆå€¼å¦‚ä½•è®¾ç½®ï¼Ÿ
- å¼‚å¸¸æ¯”ä¾‹ï¼šä»€ä¹ˆæ ·çš„å¼‚å¸¸ä¼šè¢«ç»Ÿè®¡ï¼Ÿ
- å¼‚å¸¸æ•°ï¼šé€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ

è¿™äº›éƒ½æ˜¯å®æˆ˜ä¸­éå¸¸å…³é”®çš„çŸ¥è¯†ç‚¹ï¼Œæ•¬è¯·æœŸå¾…ï¼
