---
title: "ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ï¼šLoadã€CPUã€RTå…¨æ–¹ä½é˜²æŠ¤"
date: 2025-11-21T15:55:00+08:00
draft: false
tags: ["Sentinel", "ç³»ç»Ÿä¿æŠ¤", "è‡ªé€‚åº”é™æµ", "Load", "CPU"]
categories: ["æŠ€æœ¯"]
series: ["Sentinelä»å…¥é—¨åˆ°ç²¾é€š"]
weight: 17
stage: 4
stageTitle: "è¿›é˜¶ç‰¹æ€§ç¯‡"
description: "å­¦ä¹ Sentinelçš„ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤æœºåˆ¶ï¼Œä»Loadã€CPUã€RTç­‰å¤šç»´åº¦å…¨é¢ä¿æŠ¤ç³»ç»Ÿ"
---

## å¼•è¨€ï¼šå½“æ•´ä¸ªç³»ç»Ÿéƒ½åœ¨å±é™©è¾¹ç¼˜

åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†**é™æµ**å’Œ**ç†”æ–­**ï¼Œå®ƒä»¬éƒ½æ˜¯é’ˆå¯¹**å•ä¸ªèµ„æº**çš„ä¿æŠ¤ï¼š
- é™æµï¼šä¿æŠ¤å•ä¸ªæ¥å£ä¸è¢«æµé‡å‹å®
- ç†”æ–­ï¼šä¿æŠ¤è‡ªå·±ä¸è¢«ä¾èµ–æœåŠ¡æ‹–å®

ä½†åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œè¿˜æœ‰ä¸€ç§æ›´å±é™©çš„åœºæ™¯ï¼š

> æŸå¤©æ™šä¸Š8ç‚¹ï¼Œä½ çš„ç”µå•†ç³»ç»Ÿçªç„¶æ”¶åˆ°ä¸€æ³¢è¶…å¤§æµé‡ï¼ˆå¯èƒ½æ˜¯çˆ¬è™«ã€æ”»å‡»æˆ–è€…çœŸå®ç”¨æˆ·ï¼‰ã€‚
>
> è™½ç„¶ä½ å¯¹æ¯ä¸ªæ¥å£éƒ½åšäº†é™æµï¼Œä½†è¿™æ³¢æµé‡**åˆ†æ•£åœ¨å„ä¸ªæ¥å£**ä¸Šï¼š
> - é¦–é¡µæ¥å£ï¼šQPS 500ï¼ˆé™æµé˜ˆå€¼600ï¼‰âœ…
> - æœç´¢æ¥å£ï¼šQPS 300ï¼ˆé™æµé˜ˆå€¼400ï¼‰âœ…
> - å•†å“è¯¦æƒ…ï¼šQPS 400ï¼ˆé™æµé˜ˆå€¼500ï¼‰âœ…
> - ä¸‹å•æ¥å£ï¼šQPS 200ï¼ˆé™æµé˜ˆå€¼300ï¼‰âœ…
>
> æ¯ä¸ªæ¥å£éƒ½æ²¡æœ‰è¶…è¿‡é™æµé˜ˆå€¼ï¼Œä½†**æ•´ä¸ªç³»ç»Ÿçš„è´Ÿè½½å·²ç»çˆ†ç‚¸äº†**ï¼š
> - CPUä½¿ç”¨ç‡ï¼š95%
> - ç³»ç»ŸLoadï¼š8.0ï¼ˆ4æ ¸æœºå™¨ï¼‰
> - å¹³å‡å“åº”æ—¶é—´ï¼š5ç§’
> - å†…å­˜ä½¿ç”¨ç‡ï¼š90%
>
> **ç³»ç»Ÿå·²ç»æ¿’ä¸´å´©æºƒè¾¹ç¼˜ï¼**

è¿™å°±æ˜¯**å•ä¸ªèµ„æºé™æµçš„ç›²åŒº**ï¼šæ— æ³•æ„ŸçŸ¥ç³»ç»Ÿæ•´ä½“çš„å¥åº·çŠ¶å†µã€‚

**Sentinelçš„ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ï¼ˆSystem Adaptive Protectionï¼‰å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**

---

## ç³»ç»Ÿä¿æŠ¤çš„å¿…è¦æ€§

### ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿçº§åˆ«çš„ä¿æŠ¤ï¼Ÿ

**é—®é¢˜1**ï¼šå•ä¸ªèµ„æºé™æµæ— æ³•ä¿æŠ¤æ•´ä½“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æœåŠ¡å™¨ï¼ˆ4æ ¸8Gï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¥å£Aï¼šQPS 500/600 âœ… (83%)         â”‚
â”‚ æ¥å£Bï¼šQPS 300/400 âœ… (75%)         â”‚
â”‚ æ¥å£Cï¼šQPS 400/500 âœ… (80%)         â”‚
â”‚ æ¥å£Dï¼šQPS 200/300 âœ… (67%)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½†æ˜¯...                             â”‚
â”‚ CPUä½¿ç”¨ç‡ï¼š95% âŒ                    â”‚
â”‚ Loadï¼š8.0 âŒ (4æ ¸æœºå™¨)              â”‚
â”‚ å¹³å‡RTï¼š5ç§’ âŒ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜2**ï¼šæµé‡æ¥æºä¸å‡åŒ€

- ä¸åŒæ¥å£çš„è®¡ç®—å¤æ‚åº¦ä¸åŒ
- ä¸åŒæ¥å£çš„æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ä¸åŒ
- çªå‘æµé‡å¯èƒ½æ¥è‡ªå¤šä¸ªæ¥å£

**é—®é¢˜3**ï¼šæ— æ³•åº”å¯¹çªå‘æ•…éšœ

- æ•°æ®åº“çªç„¶å˜æ…¢
- ç¼“å­˜çªç„¶å¤±æ•ˆ
- GCçªç„¶é¢‘ç¹

### ç³»ç»Ÿä¿æŠ¤çš„ç›®æ ‡

> **åœ¨ç³»ç»Ÿæ•´ä½“è´Ÿè½½è¿‡é«˜æ—¶ï¼Œä»å…¥å£å¤„å¼€å§‹é™æµï¼Œä¿è¯ç³»ç»Ÿä¸è¢«å‹å®ã€‚**

**æ ¸å¿ƒæ€æƒ³**ï¼š

1. **ç›‘æ§ç³»ç»ŸæŒ‡æ ‡**ï¼šLoadã€CPUã€RTã€çº¿ç¨‹æ•°ç­‰
2. **æ™ºèƒ½åˆ¤æ–­**ï¼šç³»ç»Ÿæ˜¯å¦å¤„äºå±é™©çŠ¶æ€
3. **å…¨å±€é™æµ**ï¼šä»å…¥å£å¤„é™æµï¼Œä¿æŠ¤æ•´ä¸ªç³»ç»Ÿ

---

## äº”å¤§ç³»ç»Ÿä¿æŠ¤æŒ‡æ ‡

Sentinelæä¾›äº†**äº”ä¸ªç»´åº¦**çš„ç³»ç»Ÿä¿æŠ¤æŒ‡æ ‡ï¼š

### 1. Loadï¼ˆç³»ç»Ÿè´Ÿè½½ï¼‰

**å®šä¹‰**ï¼šLinuxçš„ç³»ç»Ÿå¹³å‡è´Ÿè½½ï¼ˆLoad Averageï¼‰ã€‚

**å«ä¹‰**ï¼š
- Load = 1.0ï¼š1æ ¸CPUæ»¡è½½
- Load = 4.0ï¼š4æ ¸CPUæ»¡è½½
- Load = 8.0ï¼š4æ ¸CPUä¸¥é‡è¿‡è½½ï¼ˆ2å€è´Ÿè½½ï¼‰

**è§¦å‘æ¡ä»¶**ï¼š

```
å½“å‰Load >= é˜ˆå€¼ && å½“å‰å¹¶å‘çº¿ç¨‹æ•° >= ç³»ç»Ÿå®¹é‡ï¼ˆBBRç®—æ³•è®¡ç®—ï¼‰
```

**é€‚ç”¨åœºæ™¯**ï¼š
- Linuxç³»ç»Ÿï¼ˆWindowsä¸æ”¯æŒLoadæŒ‡æ ‡ï¼‰
- å¸Œæœ›æ ¹æ®æ•´ä½“è´Ÿè½½ä¿æŠ¤ç³»ç»Ÿ

**é…ç½®ç¤ºä¾‹**ï¼š

```java
SystemRule rule = new SystemRule();
rule.setHighestSystemLoad(4.0); // Loadé˜ˆå€¼ï¼š4.0
```

**è§£è¯»**ï¼šå½“ç³»ç»ŸLoad >= 4.0ï¼Œä¸”ç³»ç»Ÿå®¹é‡å·²æ»¡ï¼Œè§¦å‘é™æµã€‚

### 2. CPUä½¿ç”¨ç‡

**å®šä¹‰**ï¼šå½“å‰ç³»ç»Ÿçš„CPUä½¿ç”¨ç‡ï¼ˆ0.0 ~ 1.0ï¼‰ã€‚

**è§¦å‘æ¡ä»¶**ï¼š

```
å½“å‰CPUä½¿ç”¨ç‡ >= é˜ˆå€¼
```

**é€‚ç”¨åœºæ™¯**ï¼š
- è·¨å¹³å°ï¼ˆLinuxã€Windowséƒ½æ”¯æŒï¼‰
- CPUå¯†é›†å‹åº”ç”¨

**é…ç½®ç¤ºä¾‹**ï¼š

```java
SystemRule rule = new SystemRule();
rule.setHighestCpuUsage(0.8); // CPUä½¿ç”¨ç‡é˜ˆå€¼ï¼š80%
```

**è§£è¯»**ï¼šå½“CPUä½¿ç”¨ç‡ >= 80%ï¼Œè§¦å‘é™æµã€‚

### 3. å¹³å‡å“åº”æ—¶é—´ï¼ˆRTï¼‰

**å®šä¹‰**ï¼šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡å“åº”æ—¶é—´ã€‚

**è§¦å‘æ¡ä»¶**ï¼š

```
å½“å‰å¹³å‡RT >= é˜ˆå€¼
```

**é€‚ç”¨åœºæ™¯**ï¼š
- å…³æ³¨å“åº”æ—¶é—´çš„ç³»ç»Ÿ
- é˜²æ­¢é›ªå´©æ•ˆåº”

**é…ç½®ç¤ºä¾‹**ï¼š

```java
SystemRule rule = new SystemRule();
rule.setAvgRt(1000); // å¹³å‡RTé˜ˆå€¼ï¼š1000ms
```

**è§£è¯»**ï¼šå½“å¹³å‡å“åº”æ—¶é—´ >= 1ç§’ï¼Œè§¦å‘é™æµã€‚

### 4. å¹¶å‘çº¿ç¨‹æ•°

**å®šä¹‰**ï¼šç³»ç»Ÿå½“å‰æ­£åœ¨å¤„ç†çš„å¹¶å‘çº¿ç¨‹æ•°ã€‚

**è§¦å‘æ¡ä»¶**ï¼š

```
å½“å‰å¹¶å‘çº¿ç¨‹æ•° >= é˜ˆå€¼
```

**é€‚ç”¨åœºæ™¯**ï¼š
- é˜²æ­¢çº¿ç¨‹æ± è€—å°½
- ä¿æŠ¤ä¸‹æ¸¸ä¾èµ–

**é…ç½®ç¤ºä¾‹**ï¼š

```java
SystemRule rule = new SystemRule();
rule.setMaxThread(100); // å¹¶å‘çº¿ç¨‹æ•°é˜ˆå€¼ï¼š100
```

**è§£è¯»**ï¼šå½“å¹¶å‘çº¿ç¨‹æ•° >= 100ï¼Œè§¦å‘é™æµã€‚

### 5. å…¥å£QPS

**å®šä¹‰**ï¼šç³»ç»Ÿæ‰€æœ‰å…¥å£æµé‡çš„æ€»QPSã€‚

**è§¦å‘æ¡ä»¶**ï¼š

```
å½“å‰å…¥å£QPS >= é˜ˆå€¼
```

**é€‚ç”¨åœºæ™¯**ï¼š
- å·²çŸ¥ç³»ç»Ÿæ•´ä½“ååèƒ½åŠ›
- ç®€å•ç²—æš´çš„å…¨å±€é™æµ

**é…ç½®ç¤ºä¾‹**ï¼š

```java
SystemRule rule = new SystemRule();
rule.setQps(10000); // å…¥å£QPSé˜ˆå€¼ï¼š10000
```

**è§£è¯»**ï¼šå½“å…¥å£QPS >= 10000ï¼Œè§¦å‘é™æµã€‚

---

## è‡ªé€‚åº”ç®—æ³•ï¼šBBR

### ä»€ä¹ˆæ˜¯BBRï¼Ÿ

BBRï¼ˆBottleneck Bandwidth and Round-trip propagation timeï¼‰æ˜¯Googleæå‡ºçš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ŒSentinelå€Ÿé‰´äº†è¿™ä¸ªæ€æƒ³ç”¨äºç³»ç»Ÿä¿æŠ¤ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼š

> æ ¹æ®ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ï¼ˆCapacityï¼‰åŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼ï¼Œè®©ç³»ç»Ÿå§‹ç»ˆè¿è¡Œåœ¨æœ€ä½³çŠ¶æ€ã€‚

### BBRç®—æ³•åŸç†

**å…³é”®æŒ‡æ ‡**ï¼š

1. **maxQps**ï¼šç³»ç»Ÿå¤„ç†çš„æœ€å¤§QPSï¼ˆé€šè¿‡æ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼‰
2. **minRt**ï¼šç³»ç»Ÿå¤„ç†çš„æœ€å°å“åº”æ—¶é—´ï¼ˆé€šè¿‡æ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼‰
3. **ç³»ç»Ÿå®¹é‡ï¼ˆCapacityï¼‰**ï¼š`maxQps * minRt / 1000`

**è§¦å‘æ¡ä»¶**ï¼ˆä»¥Loadä¸ºä¾‹ï¼‰ï¼š

```java
if (currentLoad >= threshold) {
    // è®¡ç®—ç³»ç»Ÿå®¹é‡
    capacity = maxQps * minRt / 1000;

    // å¦‚æœå½“å‰å¹¶å‘çº¿ç¨‹æ•° >= å®¹é‡ï¼Œè§¦å‘é™æµ
    if (currentThread >= capacity) {
        return BLOCK;
    }
}
```

**ä¸¾ä¾‹**ï¼š

- maxQps = 1000ï¼ˆç³»ç»Ÿåœ¨æœ€ä½³çŠ¶æ€ä¸‹èƒ½å¤„ç†1000 QPSï¼‰
- minRt = 10msï¼ˆç³»ç»Ÿåœ¨æœ€ä½³çŠ¶æ€ä¸‹çš„å“åº”æ—¶é—´ï¼‰
- capacity = 1000 * 10 / 1000 = 10ï¼ˆç³»ç»Ÿå®¹é‡ï¼š10ä¸ªå¹¶å‘çº¿ç¨‹ï¼‰

**å½“Load >= é˜ˆå€¼æ—¶**ï¼š
- å¦‚æœå½“å‰å¹¶å‘çº¿ç¨‹æ•° < 10ï¼Œæ”¾è¡Œ
- å¦‚æœå½“å‰å¹¶å‘çº¿ç¨‹æ•° >= 10ï¼Œé™æµ

### ä¸ºä»€ä¹ˆéœ€è¦BBRï¼Ÿ

**é—®é¢˜**ï¼šå¦‚æœåªçœ‹Loadï¼Œå¯èƒ½ä¼šè¯¯åˆ¤ã€‚

**åœºæ™¯1**ï¼šLoadé«˜ä½†ç³»ç»Ÿæ­£å¸¸
- Load = 5.0ï¼ˆé«˜ï¼‰
- ä½†æ˜¯ç³»ç»Ÿåªæœ‰2ä¸ªå¹¶å‘è¯·æ±‚ï¼ˆä½ï¼‰
- **ä¸åº”è¯¥é™æµ**ï¼ˆå¯èƒ½æ˜¯å…¶ä»–è¿›ç¨‹å¯¼è‡´çš„Loadé«˜ï¼‰

**åœºæ™¯2**ï¼šLoadé«˜ä¸”ç³»ç»Ÿè¿‡è½½
- Load = 5.0ï¼ˆé«˜ï¼‰
- ç³»ç»Ÿæœ‰50ä¸ªå¹¶å‘è¯·æ±‚ï¼ˆé«˜ï¼‰
- ç³»ç»Ÿå®¹é‡åªæœ‰10
- **åº”è¯¥é™æµ**

BBRç®—æ³•é€šè¿‡ç»“åˆ**Load**å’Œ**å¹¶å‘çº¿ç¨‹æ•°**ï¼Œé¿å…äº†è¯¯åˆ¤ã€‚

---

## é…ç½®ç³»ç»Ÿä¿æŠ¤è§„åˆ™

### åŸºæœ¬é…ç½®

```java
import com.alibaba.csp.sentinel.slots.system.SystemRule;
import com.alibaba.csp.sentinel.slots.system.SystemRuleManager;

import java.util.ArrayList;
import java.util.List;

public class SystemRuleConfig {

    public static void initSystemRule() {
        List<SystemRule> rules = new ArrayList<>();

        SystemRule rule = new SystemRule();

        // æ–¹å¼1ï¼šLoadä¿æŠ¤ï¼ˆLinuxï¼‰
        rule.setHighestSystemLoad(4.0);

        // æ–¹å¼2ï¼šCPUä½¿ç”¨ç‡ä¿æŠ¤ï¼ˆè·¨å¹³å°ï¼‰
        // rule.setHighestCpuUsage(0.8);

        // æ–¹å¼3ï¼šå¹³å‡RTä¿æŠ¤
        // rule.setAvgRt(1000);

        // æ–¹å¼4ï¼šå¹¶å‘çº¿ç¨‹æ•°ä¿æŠ¤
        // rule.setMaxThread(100);

        // æ–¹å¼5ï¼šå…¥å£QPSä¿æŠ¤
        // rule.setQps(10000);

        rules.add(rule);
        SystemRuleManager.loadRules(rules);
        System.out.println("âœ… ç³»ç»Ÿä¿æŠ¤è§„åˆ™å·²åŠ è½½");
    }
}
```

**æ³¨æ„**ï¼š
- ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯**å…¨å±€çš„**ï¼Œåªéœ€é…ç½®ä¸€æ¡
- äº”ä¸ªæŒ‡æ ‡å¯ä»¥åŒæ—¶é…ç½®ï¼Œä»»æ„ä¸€ä¸ªè§¦å‘éƒ½ä¼šé™æµ
- ä½†é€šå¸¸åªé…ç½®1-2ä¸ªæœ€å…³é”®çš„æŒ‡æ ‡

### Dashboardé…ç½®

åœ¨Sentinel Dashboardä¸­ï¼š

1. é€‰æ‹©åº”ç”¨
2. ç‚¹å‡»"ç³»ç»Ÿè§„åˆ™"
3. ç‚¹å‡»"æ–°å¢ç³»ç»Ÿè§„åˆ™"
4. é…ç½®é˜ˆå€¼

---

## å®æˆ˜æ¡ˆä¾‹ï¼šä¿æŠ¤ç”µå•†ç³»ç»Ÿ

### åœºæ™¯æè¿°

ç”µå•†ç³»ç»Ÿéƒ¨ç½²åœ¨4æ ¸8Gçš„æœåŠ¡å™¨ä¸Šï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼š
- CPUä½¿ç”¨ç‡ï¼š50%
- Loadï¼š2.0
- å¹³å‡RTï¼š100ms
- å¹¶å‘çº¿ç¨‹æ•°ï¼š20

æŸå¤©æ™šä¸Šé­é‡æµé‡æ”»å‡»ï¼ŒQPSä»1000é£™å‡åˆ°5000ï¼Œç³»ç»Ÿæ¿’ä¸´å´©æºƒã€‚

### é…ç½®ç­–ç•¥

```java
import com.alibaba.csp.sentinel.slots.system.SystemRule;
import com.alibaba.csp.sentinel.slots.system.SystemRuleManager;

import java.util.ArrayList;
import java.util.List;

public class EcommerceSystemProtection {

    public static void main(String[] args) throws InterruptedException {
        // 1. é…ç½®ç³»ç»Ÿä¿æŠ¤è§„åˆ™
        initSystemRule();

        // 2. æ¨¡æ‹Ÿæ­£å¸¸æµé‡
        System.out.println("=== æ­£å¸¸æµé‡ ===");
        for (int i = 0; i < 10; i++) {
            simulateRequest();
            Thread.sleep(100);
        }

        // 3. æ¨¡æ‹Ÿç³»ç»Ÿè¿‡è½½
        System.out.println("\n=== ç³»ç»Ÿè¿‡è½½ï¼ˆæ¨¡æ‹ŸCPU 90%ï¼‰===");
        SystemRuleManager.loadRules(createHighLoadRules());

        for (int i = 0; i < 10; i++) {
            simulateRequest();
            Thread.sleep(100);
        }
    }

    /**
     * é…ç½®ç³»ç»Ÿä¿æŠ¤è§„åˆ™
     */
    private static void initSystemRule() {
        List<SystemRule> rules = new ArrayList<>();

        SystemRule rule = new SystemRule();
        // CPUä½¿ç”¨ç‡ä¿æŠ¤ï¼š80%
        rule.setHighestCpuUsage(0.8);

        // å¹³å‡RTä¿æŠ¤ï¼š500ms
        rule.setAvgRt(500);

        // å¹¶å‘çº¿ç¨‹æ•°ä¿æŠ¤ï¼š50
        rule.setMaxThread(50);

        rules.add(rule);
        SystemRuleManager.loadRules(rules);
        System.out.println("âœ… ç³»ç»Ÿä¿æŠ¤è§„åˆ™å·²åŠ è½½ï¼šCPU < 80%, RT < 500ms, çº¿ç¨‹æ•° < 50\n");
    }

    /**
     * åˆ›å»ºé«˜è´Ÿè½½è§„åˆ™ï¼ˆç”¨äºæ¨¡æ‹Ÿï¼‰
     */
    private static List<SystemRule> createHighLoadRules() {
        List<SystemRule> rules = new ArrayList<>();
        SystemRule rule = new SystemRule();
        rule.setHighestCpuUsage(0.5); // é™ä½é˜ˆå€¼ï¼Œæ¨¡æ‹Ÿè§¦å‘
        rules.add(rule);
        return rules;
    }

    /**
     * æ¨¡æ‹Ÿè¯·æ±‚
     */
    private static void simulateRequest() {
        try {
            // æ³¨æ„ï¼šç³»ç»Ÿä¿æŠ¤ä¸éœ€è¦å®šä¹‰èµ„æºï¼Œå®ƒä¼šè‡ªåŠ¨ä¿æŠ¤æ‰€æœ‰å…¥å£æµé‡
            // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
            System.out.println("âœ… è¯·æ±‚å¤„ç†æˆåŠŸ");
        } catch (Exception e) {
            System.out.println("ğŸ”´ è¯·æ±‚è¢«ç³»ç»Ÿä¿æŠ¤æ‹’ç»");
        }
    }
}
```

### æ•ˆæœåˆ†æ

**æ­£å¸¸æƒ…å†µ**ï¼ˆCPU 50%ï¼ŒRT 100msï¼‰ï¼š
```
âœ… è¯·æ±‚å¤„ç†æˆåŠŸ
âœ… è¯·æ±‚å¤„ç†æˆåŠŸ
âœ… è¯·æ±‚å¤„ç†æˆåŠŸ
```

**ç³»ç»Ÿè¿‡è½½**ï¼ˆCPU 90%ï¼ŒRT 500msï¼‰ï¼š
```
ğŸ”´ è¯·æ±‚è¢«ç³»ç»Ÿä¿æŠ¤æ‹’ç»
ğŸ”´ è¯·æ±‚è¢«ç³»ç»Ÿä¿æŠ¤æ‹’ç»
âœ… è¯·æ±‚å¤„ç†æˆåŠŸï¼ˆå°‘é‡æ”¾è¡Œï¼‰
ğŸ”´ è¯·æ±‚è¢«ç³»ç»Ÿä¿æŠ¤æ‹’ç»
```

**æ”¶ç›Š**ï¼š
- ç³»ç»Ÿä¸ä¼šå´©æºƒ
- CPUä½¿ç”¨ç‡è¢«æ§åˆ¶åœ¨å®‰å…¨èŒƒå›´
- å°‘é‡è¯·æ±‚ä»ç„¶èƒ½å¤ŸæˆåŠŸï¼ˆä¿è¯åŸºæœ¬å¯ç”¨ï¼‰

---

## ç³»ç»Ÿä¿æŠ¤ vs é™æµ vs ç†”æ–­

### ä¸‰è€…å¯¹æ¯”

| ç»´åº¦ | ç³»ç»Ÿä¿æŠ¤ | é™æµ | ç†”æ–­ |
|-----|---------|-----|-----|
| **ä¿æŠ¤å¯¹è±¡** | æ•´ä¸ªç³»ç»Ÿ | å•ä¸ªèµ„æº | è°ƒç”¨ä¾èµ– |
| **è§¦å‘æ¡ä»¶** | Loadã€CPUã€RTç­‰ | QPSã€çº¿ç¨‹æ•° | æ…¢è°ƒç”¨ã€å¼‚å¸¸ |
| **ä¿æŠ¤èŒƒå›´** | å…¨å±€å…¥å£ | æŒ‡å®šèµ„æº | æŒ‡å®šä¾èµ– |
| **ç²’åº¦** | ç²—ï¼ˆç³»ç»Ÿçº§ï¼‰ | ä¸­ï¼ˆèµ„æºçº§ï¼‰ | ç»†ï¼ˆè°ƒç”¨çº§ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | æ•´ä½“è¿‡è½½ | æ¥å£çƒ­ç‚¹ | ä¾èµ–æ•…éšœ |

### ä¸‰å±‚é˜²æŠ¤ä½“ç³»

```
           ç”¨æˆ·è¯·æ±‚
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç³»ç»Ÿä¿æŠ¤        â”‚  â† ç¬¬ä¸€å±‚ï¼šæ•´ä½“è´Ÿè½½ä¿æŠ¤
    â”‚  (Load/CPU/RT)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   æ¥å£é™æµ        â”‚  â† ç¬¬äºŒå±‚ï¼šæ¥å£çº§ä¿æŠ¤
    â”‚  (QPS/çº¿ç¨‹æ•°)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ä¾èµ–ç†”æ–­        â”‚  â† ç¬¬ä¸‰å±‚ï¼šä¾èµ–ä¿æŠ¤
    â”‚  (æ…¢è°ƒç”¨/å¼‚å¸¸)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
           ä¸šåŠ¡å¤„ç†
```

### å®æˆ˜ç»„åˆä½¿ç”¨

```java
public class ComprehensiveProtection {

    public static void init() {
        // ç¬¬ä¸€å±‚ï¼šç³»ç»Ÿä¿æŠ¤
        List<SystemRule> systemRules = new ArrayList<>();
        SystemRule systemRule = new SystemRule();
        systemRule.setHighestCpuUsage(0.8); // CPU 80%
        systemRule.setAvgRt(500); // RT 500ms
        systemRules.add(systemRule);
        SystemRuleManager.loadRules(systemRules);

        // ç¬¬äºŒå±‚ï¼šæ¥å£é™æµ
        List<FlowRule> flowRules = new ArrayList<>();
        FlowRule flowRule = new FlowRule();
        flowRule.setResource("orderCreate");
        flowRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        flowRule.setCount(100); // QPS 100
        flowRules.add(flowRule);
        FlowRuleManager.loadRules(flowRules);

        // ç¬¬ä¸‰å±‚ï¼šä¾èµ–ç†”æ–­
        List<DegradeRule> degradeRules = new ArrayList<>();
        DegradeRule degradeRule = new DegradeRule();
        degradeRule.setResource("callInventoryService");
        degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
        degradeRule.setCount(1000); // RT 1ç§’
        degradeRule.setSlowRatioThreshold(0.5);
        degradeRules.add(degradeRule);
        DegradeRuleManager.loadRules(degradeRules);

        System.out.println("âœ… ä¸‰å±‚é˜²æŠ¤ä½“ç³»å·²å»ºç«‹");
    }
}
```

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡

| åœºæ™¯ | æ¨èæŒ‡æ ‡ |
|-----|---------|
| LinuxæœåŠ¡å™¨ | Load + CPU |
| WindowsæœåŠ¡å™¨ | CPU + RT |
| è®¡ç®—å¯†é›†å‹ | CPU |
| IOå¯†é›†å‹ | Load + RT |
| å“åº”æ—¶é—´æ•æ„Ÿ | RT |
| å·²çŸ¥ååèƒ½åŠ› | å…¥å£QPS |

### 2. é˜ˆå€¼è®¾ç½®å»ºè®®

**CPUä½¿ç”¨ç‡**ï¼š
- æ¨èï¼š0.8ï¼ˆ80%ï¼‰
- æ¿€è¿›ï¼š0.7ï¼ˆ70%ï¼‰
- ä¿å®ˆï¼š0.9ï¼ˆ90%ï¼‰

**Load**ï¼ˆä»¥4æ ¸æœåŠ¡å™¨ä¸ºä¾‹ï¼‰ï¼š
- æ¨èï¼š3.0ï¼ˆ75%è´Ÿè½½ï¼‰
- æ¿€è¿›ï¼š2.5ï¼ˆ62.5%ï¼‰
- ä¿å®ˆï¼š4.0ï¼ˆ100%ï¼‰

**å¹³å‡RT**ï¼š
- æ¨èï¼š500ms
- æ¿€è¿›ï¼š300ms
- ä¿å®ˆï¼š1000ms

**å¹¶å‘çº¿ç¨‹æ•°**ï¼š
- æ¨èï¼šTomcatæœ€å¤§çº¿ç¨‹æ•°çš„70%
- ç¤ºä¾‹ï¼šæœ€å¤§200çº¿ç¨‹ï¼Œè®¾ç½®140

### 3. ç›‘æ§å‘Šè­¦

**å…³é”®æŒ‡æ ‡**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
- alert: HighSystemLoad
  expr: system_load > 4.0
  for: 1m
  annotations:
    summary: "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜"

- alert: SystemProtectionTriggered
  expr: rate(sentinel_system_block_total[1m]) > 10
  for: 2m
  annotations:
    summary: "ç³»ç»Ÿä¿æŠ¤é¢‘ç¹è§¦å‘"
```

### 4. é¿å…è¿‡åº¦ä¿æŠ¤

**é—®é¢˜**ï¼šé˜ˆå€¼è®¾ç½®è¿‡ä½ï¼Œå¯¼è‡´è¯¯åˆ¤ã€‚

**æ¡ˆä¾‹**ï¼š
- è®¾ç½®CPUé˜ˆå€¼50%
- æ­£å¸¸æµé‡CPUå°±è¾¾åˆ°50%
- ç³»ç»Ÿé¢‘ç¹è§¦å‘ä¿æŠ¤
- å¤§é‡æ­£å¸¸è¯·æ±‚è¢«æ‹’ç»

**è§£å†³**ï¼š
- é€šè¿‡å‹æµ‹ç¡®å®šåˆç†é˜ˆå€¼
- è§‚å¯Ÿç³»ç»Ÿåœ¨æ­£å¸¸å’Œå³°å€¼æµé‡ä¸‹çš„æŒ‡æ ‡
- é˜ˆå€¼è¦ç•™æœ‰ä½™é‡ï¼ˆå¦‚å³°å€¼60%ï¼Œè®¾ç½®80%ï¼‰

### 5. æµ‹è¯•éªŒè¯

```java
@Test
public void testSystemProtection() {
    // 1. é…ç½®ç³»ç»Ÿä¿æŠ¤è§„åˆ™
    SystemRule rule = new SystemRule();
    rule.setHighestCpuUsage(0.8);
    SystemRuleManager.loadRules(Collections.singletonList(rule));

    // 2. æ¨¡æ‹Ÿé«˜è´Ÿè½½
    // (éœ€è¦çœŸå®çš„è´Ÿè½½ç”Ÿæˆå·¥å…·ï¼Œå¦‚JMeter)

    // 3. éªŒè¯ç³»ç»Ÿä¿æŠ¤æ˜¯å¦ç”Ÿæ•ˆ
    // æ£€æŸ¥ç›‘æ§æŒ‡æ ‡ï¼šCPUã€é™æµæ¬¡æ•°ç­‰
}
```

---

## æ³¨æ„äº‹é¡¹

### 1. ç³»ç»Ÿä¿æŠ¤æ˜¯å…¨å±€çš„

**ç‰¹ç‚¹**ï¼š
- ä¸€æ—¦è§¦å‘ï¼Œæ‰€æœ‰å…¥å£æµé‡éƒ½ä¼šè¢«é™æµ
- ä¸åŒºåˆ†æ¥å£çš„é‡è¦æ€§

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´æ ¸å¿ƒæ¥å£ä¹Ÿè¢«é™æµ
- éœ€è¦é…åˆæ¥å£çº§é™æµä½¿ç”¨

### 2. LoadæŒ‡æ ‡çš„å±€é™æ€§

**é—®é¢˜**ï¼š
- åªæ”¯æŒLinux
- Loadå—å…¶ä»–è¿›ç¨‹å½±å“ï¼ˆå¦‚åŒæœºéƒ¨ç½²çš„å…¶ä»–æœåŠ¡ï¼‰
- Loadçš„æ›´æ–°æœ‰å»¶è¿Ÿ

**å»ºè®®**ï¼š
- é…åˆCPUä½¿ç”¨ç‡ä½¿ç”¨
- æˆ–è€…åªä½¿ç”¨CPUä½¿ç”¨ç‡ï¼ˆè·¨å¹³å°ï¼‰

### 3. BBRç®—æ³•çš„å†·å¯åŠ¨

**é—®é¢˜**ï¼š
- ç³»ç»Ÿåˆšå¯åŠ¨æ—¶ï¼ŒmaxQpså’ŒminRtè¿˜æ²¡ç»Ÿè®¡åˆ°
- å¯èƒ½å¯¼è‡´è¯¯åˆ¤

**è§£å†³**ï¼š
- ç³»ç»Ÿå¯åŠ¨åå…ˆé¢„çƒ­ï¼ˆå‘é€å°‘é‡è¯·æ±‚ï¼‰
- æˆ–è€…ä¸ä½¿ç”¨Loadä¿æŠ¤ï¼Œæ”¹ç”¨CPU/RT

### 4. ä¸è¦è¿‡åº¦ä¾èµ–ç³»ç»Ÿä¿æŠ¤

**åŸåˆ™**ï¼š

> ç³»ç»Ÿä¿æŠ¤æ˜¯**æœ€åä¸€é“é˜²çº¿**ï¼Œä¸åº”è¯¥æˆä¸ºä¸»è¦çš„ä¿æŠ¤æ‰‹æ®µã€‚

**æ­£ç¡®çš„åšæ³•**ï¼š
1. é¦–å…ˆåšå¥½æ¥å£çº§é™æµ
2. å…¶æ¬¡åšå¥½ä¾èµ–ç†”æ–­
3. æœ€åé…ç½®ç³»ç»Ÿä¿æŠ¤å…œåº•

---

## æ€»ç»“

æœ¬æ–‡æˆ‘ä»¬å­¦ä¹ äº†Sentinelçš„ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤æœºåˆ¶ï¼š

1. **äº”å¤§ä¿æŠ¤æŒ‡æ ‡**ï¼šLoadã€CPUã€RTã€å¹¶å‘çº¿ç¨‹æ•°ã€å…¥å£QPS
2. **BBRç®—æ³•**ï¼šæ ¹æ®ç³»ç»Ÿå®¹é‡åŠ¨æ€é™æµï¼Œé¿å…è¯¯åˆ¤
3. **é…ç½®æ–¹æ³•**ï¼šSystemRuleé…ç½®ï¼ŒDashboardå¯è§†åŒ–é…ç½®
4. **å®æˆ˜æ¡ˆä¾‹**ï¼šä¿æŠ¤ç”µå•†ç³»ç»Ÿå…äºè¿‡è½½å´©æºƒ
5. **ä¸‰å±‚é˜²æŠ¤**ï¼šç³»ç»Ÿä¿æŠ¤ + æ¥å£é™æµ + ä¾èµ–ç†”æ–­
6. **æœ€ä½³å®è·µ**ï¼šé€‰æ‹©æŒ‡æ ‡ã€è®¾ç½®é˜ˆå€¼ã€ç›‘æ§å‘Šè­¦ã€é¿å…è¿‡åº¦ä¿æŠ¤

**æ ¸å¿ƒè¦ç‚¹**ï¼š

> ç³»ç»Ÿä¿æŠ¤æ˜¯Sentinelçš„"æ ¸æ­¦å™¨"ï¼Œå®ƒä»æ•´ä½“è§’åº¦ä¿æŠ¤ç³»ç»Ÿä¸è¢«å‹å®ã€‚ä½†è¦è°¨æ…ä½¿ç”¨ï¼Œé˜ˆå€¼è®¾ç½®è¦åˆç†ï¼Œé¿å…è¯¯ä¼¤æ­£å¸¸æµé‡ã€‚

**ä¸‹ä¸€ç¯‡é¢„å‘Š**ï¼š

æˆ‘ä»¬å°†å­¦ä¹ **çƒ­ç‚¹å‚æ•°é™æµ**ï¼š
- ä»€ä¹ˆæ˜¯çƒ­ç‚¹æ•°æ®ï¼Ÿ
- ä¸ºä»€ä¹ˆæ™®é€šé™æµæ— æ³•ä¿æŠ¤çƒ­ç‚¹ï¼Ÿ
- å¦‚ä½•é…ç½®çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™ï¼Ÿ
- ç§’æ€å•†å“ã€çƒ­é—¨ä¸»æ’­çš„ä¿æŠ¤æ–¹æ¡ˆ

è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢æ›´ç²¾ç»†åŒ–çš„é™æµç­–ç•¥ï¼
