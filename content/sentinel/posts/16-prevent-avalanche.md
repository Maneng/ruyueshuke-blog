---
title: "å®æˆ˜ï¼šé˜²æ­¢å¾®æœåŠ¡é›ªå´©ä¼ æ’­"
date: 2025-11-20T15:50:00+08:00
draft: false
tags: ["Sentinel", "æœåŠ¡é›ªå´©", "ç†”æ–­é™çº§", "å®æˆ˜æ¡ˆä¾‹"]
categories: ["æŠ€æœ¯"]
series: ["Sentinelä»å…¥é—¨åˆ°ç²¾é€š"]
weight: 16
stage: 3
stageTitle: "ç†”æ–­é™çº§ç¯‡"
description: "é€šè¿‡ç†”æ–­é™çº§æœºåˆ¶ï¼Œé˜»æ­¢æ•…éšœåœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯ä¸­ä¼ æ’­"
---

## å¼•è¨€ï¼šä¸€åœºçœŸå®çš„é›ªå´©äº‹æ•…

2018å¹´æŸç”µå•†å¹³å°çš„åŒ11å¤§ä¿ƒï¼Œå‡Œæ™¨2ç‚¹ï¼Œä¸€åœºå™©æ¢¦å¼€å§‹äº†ï¼š

> **2:00** - å•†å“è¯¦æƒ…æœåŠ¡çš„MySQLæ•°æ®åº“å‡ºç°æ…¢æŸ¥è¯¢ï¼Œå“åº”æ—¶é—´ä»10msé£™å‡åˆ°5ç§’
>
> **2:02** - å•†å“æœåŠ¡çš„Tomcatçº¿ç¨‹æ± è¢«è€—å°½ï¼ˆ200ä¸ªçº¿ç¨‹å…¨éƒ¨é˜»å¡åœ¨æ•°æ®åº“æŸ¥è¯¢ä¸Šï¼‰
>
> **2:03** - è®¢å•æœåŠ¡è°ƒç”¨å•†å“æœåŠ¡è¶…æ—¶ï¼Œè®¢å•æœåŠ¡çš„çº¿ç¨‹æ± ä¹Ÿè¢«è€—å°½
>
> **2:04** - ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡è¶…æ—¶ï¼Œç”¨æˆ·æœåŠ¡ä¹ŸæŒ‚äº†
>
> **2:05** - æ•´ä¸ªç³»ç»Ÿç˜«ç—ªï¼Œé¦–é¡µæ— æ³•è®¿é—®ï¼Œäº¤æ˜“å…¨éƒ¨å¤±è´¥
>
> **æŸå¤±**ï¼š10åˆ†é’Ÿå†…æŸå¤±è®¢å•è¶…è¿‡5000ä¸‡å…ƒ

è¿™å°±æ˜¯**å¾®æœåŠ¡é›ªå´©æ•ˆåº”**çš„çœŸå®æ¡ˆä¾‹ã€‚

ä¸€ä¸ªæ•°æ®åº“çš„æ…¢æŸ¥è¯¢ï¼Œåƒå¤šç±³è¯ºéª¨ç‰Œä¸€æ ·ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚

**ä»Šå¤©æˆ‘ä»¬å°±æ¥å­¦ä¹ å¦‚ä½•ç”¨Sentinelé˜²æ­¢è¿™ç§é›ªå´©çš„å‘ç”Ÿã€‚**

---

## åœºæ™¯æè¿°ï¼šä¸€ä¸ªå…¸å‹çš„è°ƒç”¨é“¾è·¯

### ç³»ç»Ÿæ¶æ„

æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¸å‹çš„å¾®æœåŠ¡æ¶æ„ï¼š

```
ç”¨æˆ·è¯·æ±‚
    â†“
[ç”¨æˆ·æœåŠ¡ User-Service]
    â†“ è°ƒç”¨
[è®¢å•æœåŠ¡ Order-Service]
    â†“ è°ƒç”¨
[å•†å“æœåŠ¡ Product-Service]
    â†“ æŸ¥è¯¢
[MySQLæ•°æ®åº“]
```

**è°ƒç”¨å…³ç³»**ï¼š

- ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ï¼šæŸ¥è¯¢ç”¨æˆ·çš„è®¢å•åˆ—è¡¨
- è®¢å•æœåŠ¡ â†’ å•†å“æœåŠ¡ï¼šæŸ¥è¯¢è®¢å•ä¸­çš„å•†å“è¯¦æƒ…
- å•†å“æœåŠ¡ â†’ MySQLï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯

### æ­£å¸¸æµç¨‹

1. ç”¨æˆ·è®¿é—®"æˆ‘çš„è®¢å•"é¡µé¢
2. ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡çš„`/order/list`æ¥å£
3. è®¢å•æœåŠ¡è¿”å›è®¢å•IDåˆ—è¡¨
4. è®¢å•æœåŠ¡è°ƒç”¨å•†å“æœåŠ¡çš„`/product/detail`æ¥å£ï¼Œæ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯
5. å•†å“æœåŠ¡æŸ¥è¯¢MySQLæ•°æ®åº“
6. å±‚å±‚è¿”å›ï¼Œç”¨æˆ·çœ‹åˆ°è®¢å•åˆ—è¡¨

**æ­£å¸¸æƒ…å†µä¸‹çš„å“åº”æ—¶é—´**ï¼š
- å•†å“æœåŠ¡æŸ¥è¯¢æ•°æ®åº“ï¼š10ms
- è®¢å•æœåŠ¡è°ƒç”¨å•†å“æœåŠ¡ï¼š50ms
- ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡ï¼š100ms
- ç”¨æˆ·çœ‹åˆ°é¡µé¢ï¼š200ms

---

## é—®é¢˜åˆ†æï¼šé›ªå´©æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿ

### æ•…éšœèµ·ç‚¹ï¼šå•†å“æœåŠ¡çš„æ•°æ®åº“æ…¢æŸ¥è¯¢

æŸå¤©å‡Œæ™¨ï¼Œå•†å“æœåŠ¡çš„MySQLæ•°æ®åº“å‡ºç°äº†æ…¢æŸ¥è¯¢ï¼š

```sql
-- æ…¢æŸ¥è¯¢ï¼šå…¨è¡¨æ‰«æï¼Œè€—æ—¶5ç§’
SELECT * FROM product WHERE category = 'phone' AND price > 5000 ORDER BY sales DESC;
```

**ç›´æ¥å½±å“**ï¼šå•†å“æœåŠ¡çš„å“åº”æ—¶é—´ä»10msé£™å‡åˆ°5ç§’ã€‚

### ç¬¬ä¸€å±‚ä¼ æ’­ï¼šå•†å“æœåŠ¡çº¿ç¨‹æ± è€—å°½

```
å•†å“æœåŠ¡ï¼š
- Tomcatæœ€å¤§çº¿ç¨‹æ•°ï¼š200
- æ¯ä¸ªè¯·æ±‚ç­‰å¾…5ç§’
- QPSï¼š100ï¼ˆå‡è®¾ï¼‰

ç»“æœï¼š
- 5ç§’å†…åˆ°è¾¾çš„è¯·æ±‚ = 100 * 5 = 500ä¸ª
- çº¿ç¨‹æ± åªæœ‰200ä¸ªï¼Œ300ä¸ªè¯·æ±‚æ’é˜Ÿç­‰å¾…
- çº¿ç¨‹æ± è¢«è€—å°½ï¼
```

**ç—‡çŠ¶**ï¼š
- å•†å“æœåŠ¡çš„æ‰€æœ‰æ¥å£éƒ½å˜æ…¢
- CPUä½¿ç”¨ç‡ä¸é«˜ï¼ˆå¤§éƒ¨åˆ†çº¿ç¨‹åœ¨ç­‰å¾…æ•°æ®åº“ï¼‰
- å†…å­˜ä½¿ç”¨ç‡ä¸é«˜
- ä½†å“åº”æ—¶é—´æé•¿ï¼Œæ¥è¿‘äºä¸å¯ç”¨

### ç¬¬äºŒå±‚ä¼ æ’­ï¼šè®¢å•æœåŠ¡è¢«æ‹–å®

è®¢å•æœåŠ¡è°ƒç”¨å•†å“æœåŠ¡ï¼Œè®¾ç½®çš„è¶…æ—¶æ—¶é—´æ˜¯3ç§’ï¼š

```java
// è®¢å•æœåŠ¡è°ƒç”¨å•†å“æœåŠ¡
@GetMapping("/order/list")
public List<Order> getOrderList(Long userId) {
    List<Order> orders = orderDao.findByUserId(userId);

    // æ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆ10ä¸ªè®¢å•ï¼Œæ¯ä¸ªè®¢å•1ä¸ªå•†å“ï¼‰
    for (Order order : orders) {
        Product product = productClient.getProduct(order.getProductId()); // è¶…æ—¶3ç§’
        order.setProduct(product);
    }

    return orders;
}
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªè®¢å•æŸ¥è¯¢ä¸€æ¬¡å•†å“ï¼Œ10ä¸ªè®¢å• = 10æ¬¡è°ƒç”¨
- æ¯æ¬¡è°ƒç”¨è¶…æ—¶3ç§’
- 10æ¬¡è°ƒç”¨ = 30ç§’
- è®¢å•æœåŠ¡çš„çº¿ç¨‹è¢«é˜»å¡30ç§’ï¼

**ç»“æœ**ï¼š
- è®¢å•æœåŠ¡çš„çº¿ç¨‹æ± ä¹Ÿè¢«è€—å°½
- è®¢å•æœåŠ¡è‡ªèº«çš„å…¶ä»–æ¥å£ä¹Ÿå˜æ…¢
- é›ªå´©ç»§ç»­å‘ä¸Šä¼ æ’­

### ç¬¬ä¸‰å±‚ä¼ æ’­ï¼šç”¨æˆ·æœåŠ¡å´©æºƒ

ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡ï¼š

```java
// ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡
@GetMapping("/user/orders")
public List<Order> getUserOrders(Long userId) {
    return orderClient.getOrderList(userId); // è¶…æ—¶5ç§’
}
```

**é—®é¢˜**ï¼š
- è°ƒç”¨è®¢å•æœåŠ¡è¶…æ—¶5ç§’
- ç”¨æˆ·æœåŠ¡çš„çº¿ç¨‹ä¹Ÿè¢«é˜»å¡
- ç”¨æˆ·æœåŠ¡å´©æºƒ

### é›ªå´©è·¯å¾„å›¾

```
         MySQLæ…¢æŸ¥è¯¢ï¼ˆ5ç§’ï¼‰
                â†“
      å•†å“æœåŠ¡çº¿ç¨‹æ± è€—å°½
                â†“
    è®¢å•æœåŠ¡è°ƒç”¨è¶…æ—¶ï¼ˆ3ç§’ Ã— 10æ¬¡ï¼‰
                â†“
      è®¢å•æœåŠ¡çº¿ç¨‹æ± è€—å°½
                â†“
    ç”¨æˆ·æœåŠ¡è°ƒç”¨è¶…æ—¶ï¼ˆ5ç§’ï¼‰
                â†“
      ç”¨æˆ·æœåŠ¡çº¿ç¨‹æ± è€—å°½
                â†“
           æ•´ä¸ªç³»ç»Ÿå´©æºƒ
```

**å…³é”®é—®é¢˜**ï¼š

1. **åŒæ­¥é˜»å¡**ï¼šæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯åŒæ­¥ç­‰å¾…ï¼Œçº¿ç¨‹è¢«é˜»å¡
2. **æ— ç†”æ–­æœºåˆ¶**ï¼šæ˜çŸ¥é“ä¸‹æ¸¸æœåŠ¡å·²ç»å¾ˆæ…¢ï¼Œè¿˜ç»§ç»­è°ƒç”¨
3. **èµ„æºè€—å°½**ï¼šçº¿ç¨‹æ± è¢«è€—å°½ï¼Œæ— æ³•å¤„ç†æ–°è¯·æ±‚
4. **è¿é”ååº”**ï¼šæ•…éšœæ²¿ç€è°ƒç”¨é“¾å‘ä¸Šä¼ æ’­

---

## è§£å†³æ–¹æ¡ˆï¼šå¤šå±‚ç†”æ–­éš”ç¦»

### ç†”æ–­ç­–ç•¥è®¾è®¡

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨æ¯ä¸€å±‚æœåŠ¡ä¸­ï¼Œå¯¹ä¸‹æ¸¸æœåŠ¡è¿›è¡Œç†”æ–­ä¿æŠ¤ã€‚

```
[ç”¨æˆ·æœåŠ¡]
    â†“ ç†”æ–­ä¿æŠ¤
[è®¢å•æœåŠ¡]
    â†“ ç†”æ–­ä¿æŠ¤
[å•†å“æœåŠ¡]
    â†“
[MySQL]ï¼ˆæ•…éšœç‚¹ï¼‰
```

**ç†”æ–­è§„åˆ™**ï¼š

1. **è®¢å•æœåŠ¡å¯¹å•†å“æœåŠ¡çš„ç†”æ–­**ï¼š
   - ç­–ç•¥ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹
   - é˜ˆå€¼ï¼šRT > 1ç§’ç®—æ…¢è°ƒç”¨ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹ > 50%
   - ç†”æ–­æ—¶é•¿ï¼š10ç§’
   - é™çº§æ–¹æ¡ˆï¼šè¿”å›é»˜è®¤å•†å“ä¿¡æ¯

2. **ç”¨æˆ·æœåŠ¡å¯¹è®¢å•æœåŠ¡çš„ç†”æ–­**ï¼š
   - ç­–ç•¥ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹
   - é˜ˆå€¼ï¼šRT > 2ç§’ç®—æ…¢è°ƒç”¨ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹ > 50%
   - ç†”æ–­æ—¶é•¿ï¼š15ç§’
   - é™çº§æ–¹æ¡ˆï¼šè¿”å›"è®¢å•æœåŠ¡ç¹å¿™"

---

## å®Œæ•´ä»£ç å®ç°

### 1. å•†å“æœåŠ¡ï¼ˆProduct-Serviceï¼‰

å•†å“æœåŠ¡æœ¬èº«ä¸åšç†”æ–­ï¼Œä½†å¯ä»¥åš**é™æµä¿æŠ¤**ï¼Œé˜²æ­¢è¢«å‹å®ã€‚

```java
@RestController
@RequestMapping("/product")
public class ProductController {

    @Autowired
    private ProductService productService;

    @GetMapping("/detail/{id}")
    @SentinelResource(value = "getProductDetail")
    public Product getProductDetail(@PathVariable Long id) {
        // æŸ¥è¯¢æ•°æ®åº“ï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰
        return productService.getProductById(id);
    }
}
```

**é™æµè§„åˆ™**ï¼š

```java
@Configuration
public class SentinelConfig {

    @PostConstruct
    public void initFlowRule() {
        List<FlowRule> rules = new ArrayList<>();

        // é™æµï¼šQPSä¸è¶…è¿‡200
        FlowRule rule = new FlowRule();
        rule.setResource("getProductDetail");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(200);
        rules.add(rule);

        FlowRuleManager.loadRules(rules);
    }
}
```

### 2. è®¢å•æœåŠ¡ï¼ˆOrder-Serviceï¼‰

è®¢å•æœåŠ¡å¯¹å•†å“æœåŠ¡è¿›è¡Œ**ç†”æ–­ä¿æŠ¤**ã€‚

```java
@Service
public class OrderService {

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private RedisTemplate<String, Product> redisTemplate;

    /**
     * æŸ¥è¯¢è®¢å•åˆ—è¡¨
     */
    public List<OrderVO> getOrderList(Long userId) {
        // 1. æŸ¥è¯¢è®¢å•
        List<Order> orders = orderDao.findByUserId(userId);

        // 2. æ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆå¸¦ç†”æ–­ä¿æŠ¤ï¼‰
        List<OrderVO> orderVOList = new ArrayList<>();
        for (Order order : orders) {
            OrderVO vo = new OrderVO();
            vo.setOrderId(order.getId());
            vo.setProductId(order.getProductId());

            // è°ƒç”¨å•†å“æœåŠ¡ï¼ˆå¸¦ç†”æ–­ï¼‰
            Product product = getProductWithCircuitBreaker(order.getProductId());
            vo.setProduct(product);

            orderVOList.add(vo);
        }

        return orderVOList;
    }

    /**
     * è°ƒç”¨å•†å“æœåŠ¡ï¼ˆå¸¦ç†”æ–­ä¿æŠ¤ï¼‰
     */
    @SentinelResource(
        value = "callProductService",
        blockHandler = "productServiceBlockHandler",
        fallback = "productServiceFallback"
    )
    public Product getProductWithCircuitBreaker(Long productId) {
        // è°ƒç”¨å•†å“æœåŠ¡
        String url = "http://product-service/product/detail/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }

    /**
     * ç†”æ–­é™çº§å¤„ç†ï¼šè¿”å›ç¼“å­˜æ•°æ®
     */
    public Product productServiceBlockHandler(Long productId, BlockException ex) {
        System.out.println("å•†å“æœåŠ¡ç†”æ–­ï¼Œè¿”å›ç¼“å­˜æ•°æ®");

        // ä»Redisè·å–ç¼“å­˜
        String key = "product:" + productId;
        Product product = redisTemplate.opsForValue().get(key);

        if (product != null) {
            return product;
        }

        // ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œè¿”å›é»˜è®¤æ•°æ®
        Product defaultProduct = new Product();
        defaultProduct.setId(productId);
        defaultProduct.setName("å•†å“ä¿¡æ¯æš‚æ—¶æ— æ³•è·å–");
        defaultProduct.setPrice(0.0);
        return defaultProduct;
    }

    /**
     * å¼‚å¸¸é™çº§å¤„ç†
     */
    public Product productServiceFallback(Long productId, Throwable ex) {
        System.out.println("å•†å“æœåŠ¡è°ƒç”¨å¼‚å¸¸ï¼š" + ex.getMessage());
        return productServiceBlockHandler(productId, null);
    }
}
```

**ç†”æ–­è§„åˆ™é…ç½®**ï¼š

```java
@Configuration
public class OrderSentinelConfig {

    @PostConstruct
    public void initDegradeRule() {
        List<DegradeRule> rules = new ArrayList<>();

        // å¯¹å•†å“æœåŠ¡çš„ç†”æ–­è§„åˆ™
        DegradeRule rule = new DegradeRule();
        rule.setResource("callProductService");
        rule.setGrade(RuleConstant.DEGRADE_GRADE_RT); // æ…¢è°ƒç”¨æ¯”ä¾‹
        rule.setCount(1000); // RT > 1ç§’ç®—æ…¢è°ƒç”¨
        rule.setSlowRatioThreshold(0.5); // æ…¢è°ƒç”¨æ¯”ä¾‹50%
        rule.setMinRequestAmount(5);
        rule.setStatIntervalMs(10000);
        rule.setTimeWindow(10); // ç†”æ–­10ç§’

        rules.add(rule);
        DegradeRuleManager.loadRules(rules);
        System.out.println("âœ… è®¢å•æœåŠ¡ç†”æ–­è§„åˆ™å·²åŠ è½½");
    }
}
```

### 3. ç”¨æˆ·æœåŠ¡ï¼ˆUser-Serviceï¼‰

ç”¨æˆ·æœåŠ¡å¯¹è®¢å•æœåŠ¡è¿›è¡Œ**ç†”æ–­ä¿æŠ¤**ã€‚

```java
@Service
public class UserService {

    @Autowired
    private RestTemplate restTemplate;

    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @SentinelResource(
        value = "callOrderService",
        blockHandler = "orderServiceBlockHandler",
        fallback = "orderServiceFallback"
    )
    public List<OrderVO> getUserOrders(Long userId) {
        // è°ƒç”¨è®¢å•æœåŠ¡
        String url = "http://order-service/order/list?userId=" + userId;
        return restTemplate.getForObject(url, List.class);
    }

    /**
     * è®¢å•æœåŠ¡ç†”æ–­é™çº§
     */
    public List<OrderVO> orderServiceBlockHandler(Long userId, BlockException ex) {
        System.out.println("è®¢å•æœåŠ¡ç†”æ–­ï¼Œè¿”å›å‹å¥½æç¤º");

        // è¿”å›ç©ºåˆ—è¡¨ + æç¤ºä¿¡æ¯
        List<OrderVO> emptyList = new ArrayList<>();
        OrderVO tip = new OrderVO();
        tip.setMessage("è®¢å•æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        emptyList.add(tip);
        return emptyList;
    }

    /**
     * è®¢å•æœåŠ¡è°ƒç”¨å¼‚å¸¸
     */
    public List<OrderVO> orderServiceFallback(Long userId, Throwable ex) {
        System.out.println("è®¢å•æœåŠ¡è°ƒç”¨å¼‚å¸¸ï¼š" + ex.getMessage());
        return orderServiceBlockHandler(userId, null);
    }
}
```

**ç†”æ–­è§„åˆ™é…ç½®**ï¼š

```java
@Configuration
public class UserSentinelConfig {

    @PostConstruct
    public void initDegradeRule() {
        List<DegradeRule> rules = new ArrayList<>();

        // å¯¹è®¢å•æœåŠ¡çš„ç†”æ–­è§„åˆ™
        DegradeRule rule = new DegradeRule();
        rule.setResource("callOrderService");
        rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
        rule.setCount(2000); // RT > 2ç§’ç®—æ…¢è°ƒç”¨
        rule.setSlowRatioThreshold(0.5);
        rule.setMinRequestAmount(5);
        rule.setStatIntervalMs(10000);
        rule.setTimeWindow(15); // ç†”æ–­15ç§’

        rules.add(rule);
        DegradeRuleManager.loadRules(rules);
        System.out.println("âœ… ç”¨æˆ·æœåŠ¡ç†”æ–­è§„åˆ™å·²åŠ è½½");
    }
}
```

---

## æ•…éšœæ³¨å…¥æµ‹è¯•

### æµ‹è¯•ç›®æ ‡

éªŒè¯å½“å•†å“æœåŠ¡å‡ºç°æ…¢æŸ¥è¯¢æ—¶ï¼Œç†”æ–­æœºåˆ¶èƒ½å¦æœ‰æ•ˆé˜²æ­¢é›ªå´©ã€‚

### æµ‹è¯•æ­¥éª¤

#### 1. æ¨¡æ‹Ÿå•†å“æœåŠ¡æ…¢æŸ¥è¯¢

åœ¨å•†å“æœåŠ¡ä¸­æ·»åŠ ä¸€ä¸ªå¼€å…³ï¼Œå¯ä»¥æ¨¡æ‹Ÿæ…¢æŸ¥è¯¢ï¼š

```java
@RestController
@RequestMapping("/product")
public class ProductController {

    // æ•…éšœæ³¨å…¥å¼€å…³
    private volatile boolean slowQuery = false;

    @GetMapping("/detail/{id}")
    @SentinelResource(value = "getProductDetail")
    public Product getProductDetail(@PathVariable Long id) throws InterruptedException {
        // æ¨¡æ‹Ÿæ…¢æŸ¥è¯¢
        if (slowQuery) {
            Thread.sleep(5000); // 5ç§’
        }

        return productService.getProductById(id);
    }

    // æ•…éšœæ³¨å…¥æ¥å£
    @PostMapping("/fault/slow")
    public String enableSlowQuery(@RequestParam boolean enable) {
        this.slowQuery = enable;
        return "æ…¢æŸ¥è¯¢å·²" + (enable ? "å¼€å¯" : "å…³é—­");
    }
}
```

#### 2. å‹æµ‹å·¥å…·

ä½¿ç”¨JMeteræˆ–wrkè¿›è¡Œå‹æµ‹ï¼š

```bash
# ä½¿ç”¨wrkå‹æµ‹
wrk -t10 -c100 -d60s http://localhost:8080/user/orders?userId=1
```

#### 3. å¼€å¯æ•…éšœæ³¨å…¥

```bash
# å¼€å¯å•†å“æœåŠ¡æ…¢æŸ¥è¯¢
curl -X POST "http://localhost:8001/product/fault/slow?enable=true"
```

#### 4. è§‚å¯Ÿæ—¥å¿—

**å•†å“æœåŠ¡æ—¥å¿—**ï¼š

```
âš ï¸  æ…¢æŸ¥è¯¢ï¼šè€—æ—¶5000ms
âš ï¸  æ…¢æŸ¥è¯¢ï¼šè€—æ—¶5000ms
âš ï¸  æ…¢æŸ¥è¯¢ï¼šè€—æ—¶5000ms
```

**è®¢å•æœåŠ¡æ—¥å¿—**ï¼š

```
âš ï¸  è°ƒç”¨å•†å“æœåŠ¡ï¼Œè€—æ—¶5100ms
âš ï¸  è°ƒç”¨å•†å“æœåŠ¡ï¼Œè€—æ—¶5100ms
ğŸ”´ å•†å“æœåŠ¡ç†”æ–­ï¼Œè¿”å›ç¼“å­˜æ•°æ®  â† ç†”æ–­ç”Ÿæ•ˆï¼
ğŸ”´ å•†å“æœåŠ¡ç†”æ–­ï¼Œè¿”å›ç¼“å­˜æ•°æ®
ğŸ”´ å•†å“æœåŠ¡ç†”æ–­ï¼Œè¿”å›ç¼“å­˜æ•°æ®
```

**ç”¨æˆ·æœåŠ¡æ—¥å¿—**ï¼š

```
âœ… è°ƒç”¨è®¢å•æœåŠ¡æˆåŠŸï¼Œè€—æ—¶150ms  â† è®¢å•æœåŠ¡å› ä¸ºç†”æ–­äº†å•†å“æœåŠ¡ï¼Œè‡ªèº«æ­£å¸¸
âœ… è°ƒç”¨è®¢å•æœåŠ¡æˆåŠŸï¼Œè€—æ—¶150ms
âœ… è°ƒç”¨è®¢å•æœåŠ¡æˆåŠŸï¼Œè€—æ—¶150ms
```

### æµ‹è¯•ç»“æœå¯¹æ¯”

| åœºæ™¯ | æ— ç†”æ–­ | æœ‰ç†”æ–­ |
|-----|-------|-------|
| å•†å“æœåŠ¡å“åº”æ—¶é—´ | 5ç§’ | 5ç§’ |
| è®¢å•æœåŠ¡å“åº”æ—¶é—´ | 30ç§’ï¼ˆè¶…æ—¶ï¼‰ | 150ms âœ… |
| ç”¨æˆ·æœåŠ¡å“åº”æ—¶é—´ | è¶…æ—¶ | 200ms âœ… |
| ç”¨æˆ·ä½“éªŒ | ç™½å±/æŠ¥é”™ | æ­£å¸¸ï¼ˆéƒ¨åˆ†æ•°æ®é™çº§ï¼‰ âœ… |
| ç³»ç»Ÿç¨³å®šæ€§ | å…¨é“¾è·¯å´©æºƒ âŒ | æ•…éšœéš”ç¦» âœ… |

---

## æ•ˆæœéªŒè¯ï¼šé›ªå´©è¢«é˜»æ­¢äº†

### éªŒè¯ç‚¹1ï¼šè®¢å•æœåŠ¡æœªè¢«æ‹–å®

è™½ç„¶å•†å“æœåŠ¡å“åº”æ…¢ï¼Œä½†è®¢å•æœåŠ¡ï¼š
- æ£€æµ‹åˆ°å•†å“æœåŠ¡å“åº”æ…¢ï¼ˆRT > 1ç§’ï¼‰
- æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡50%
- **è‡ªåŠ¨ç†”æ–­**ï¼Œåœæ­¢è°ƒç”¨å•†å“æœåŠ¡
- è¿”å›ç¼“å­˜æ•°æ®æˆ–é»˜è®¤å€¼
- **è®¢å•æœåŠ¡è‡ªèº«ä¿æŒæ­£å¸¸å“åº”æ—¶é—´**

### éªŒè¯ç‚¹2ï¼šç”¨æˆ·æœåŠ¡æœªå—å½±å“

ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡ï¼š
- è®¢å•æœåŠ¡å› ä¸ºç†”æ–­äº†å•†å“æœåŠ¡ï¼Œå“åº”æ—¶é—´æ­£å¸¸ï¼ˆ150msï¼‰
- ç”¨æˆ·æœåŠ¡ä¸éœ€è¦ç†”æ–­
- **ç”¨æˆ·ä½“éªŒè‰¯å¥½**

### éªŒè¯ç‚¹3ï¼šæ•…éšœè‡ªåŠ¨æ¢å¤

å½“å•†å“æœåŠ¡çš„æ…¢æŸ¥è¯¢é—®é¢˜è§£å†³åï¼š
- ç†”æ–­æ—¶é•¿åˆ°æœŸï¼ˆ10ç§’ï¼‰
- ç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€
- æ¢æµ‹è¯·æ±‚æˆåŠŸ
- **è‡ªåŠ¨æ¢å¤æ­£å¸¸è°ƒç”¨**

### å®Œæ•´çš„é˜²å¾¡ä½“ç³»

```
         MySQLæ…¢æŸ¥è¯¢ï¼ˆ5ç§’ï¼‰
                â†“
      å•†å“æœåŠ¡å“åº”æ…¢ï¼ˆ5ç§’ï¼‰
                â†“
    è®¢å•æœåŠ¡æ£€æµ‹åˆ°æ…¢è°ƒç”¨
                â†“
         ğŸ›¡ï¸ ç†”æ–­å™¨å¼€å¯  â† é›ªå´©è¢«é˜»æ­¢ï¼
                â†“
    è®¢å•æœåŠ¡è¿”å›é™çº§æ•°æ®
                â†“
      è®¢å•æœåŠ¡ä¿æŒæ­£å¸¸ï¼ˆ150msï¼‰
                â†“
    ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡æ­£å¸¸
                â†“
           ç”¨æˆ·ä½“éªŒè‰¯å¥½
```

---

## æœ€ä½³å®è·µæ€»ç»“

### 1. å¤šå±‚é˜²æŠ¤åŸåˆ™

```
ç¬¬ä¸€å±‚ï¼šé™æµï¼ˆä¿æŠ¤è‡ªå·±ï¼‰
ç¬¬äºŒå±‚ï¼šç†”æ–­ï¼ˆä¿æŠ¤è‡ªå·±ä¸è¢«ä¾èµ–æœåŠ¡æ‹–å®ï¼‰
ç¬¬ä¸‰å±‚ï¼šé™çº§ï¼ˆæä¾›æœ‰é™æœåŠ¡ï¼‰
ç¬¬å››å±‚ï¼šè¶…æ—¶ï¼ˆé¿å…æ— é™ç­‰å¾…ï¼‰
```

### 2. ç†”æ–­è§„åˆ™é…ç½®å»ºè®®

| å±‚çº§ | ç†”æ–­é˜ˆå€¼ | ç†”æ–­æ—¶é•¿ | ç†ç”± |
|-----|---------|---------|-----|
| é è¿‘åº•å±‚ | æ›´ä¸¥æ ¼ï¼ˆRT 1ç§’ï¼‰ | æ›´çŸ­ï¼ˆ10ç§’ï¼‰ | æ•…éšœæºå¤´ï¼Œå¿«é€Ÿéš”ç¦» |
| é è¿‘ä¸Šå±‚ | æ›´å®½æ¾ï¼ˆRT 2ç§’ï¼‰ | æ›´é•¿ï¼ˆ15ç§’ï¼‰ | ç»™ä¸‹æ¸¸æ›´å¤šæ¢å¤æ—¶é—´ |

### 3. é™çº§æ•°æ®å‡†å¤‡

- **ä¼˜å…ˆçº§1**ï¼šç¼“å­˜ï¼ˆRedisã€æœ¬åœ°ç¼“å­˜ï¼‰
- **ä¼˜å…ˆçº§2**ï¼šé™æ€æ•°æ®ï¼ˆé…ç½®ã€æ•°æ®åº“ï¼‰
- **ä¼˜å…ˆçº§3**ï¼šé»˜è®¤å€¼/ç©ºå¯¹è±¡
- **ä¼˜å…ˆçº§4**ï¼šå‹å¥½æç¤º

### 4. ç›‘æ§ä¸å‘Šè­¦

**å…³é”®æŒ‡æ ‡**ï¼š

- ç†”æ–­æ¬¡æ•°ï¼š`sentinel_degrade_total`
- æ…¢è°ƒç”¨æ¯”ä¾‹ï¼š`sentinel_slow_ratio`
- é™çº§è¿”å›ç‡ï¼š`sentinel_fallback_ratio`

**å‘Šè­¦è§„åˆ™**ï¼š

```yaml
# ç†”æ–­é¢‘ç¹å‘Šè­¦
- alert: HighDegradeRate
  expr: rate(sentinel_degrade_total[5m]) > 10
  annotations:
    summary: "æœåŠ¡ç†”æ–­é¢‘ç¹"
```

### 5. å‹æµ‹éªŒè¯

**å¿…åšçš„å‹æµ‹**ï¼š

1. **æ­£å¸¸å‹æµ‹**ï¼šéªŒè¯æœåŠ¡æ‰¿è½½èƒ½åŠ›
2. **æ•…éšœæ³¨å…¥**ï¼šæ¨¡æ‹Ÿä¾èµ–æœåŠ¡æ•…éšœ
3. **é›ªå´©æµ‹è¯•**ï¼šéªŒè¯ç†”æ–­æ˜¯å¦ç”Ÿæ•ˆ
4. **æ¢å¤æµ‹è¯•**ï¼šéªŒè¯ç†”æ–­å™¨è‡ªåŠ¨æ¢å¤

---

## æ€»ç»“

æœ¬æ–‡æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å¾®æœåŠ¡è°ƒç”¨é“¾è·¯æ¡ˆä¾‹ï¼Œå­¦ä¹ äº†å¦‚ä½•é˜²æ­¢æœåŠ¡é›ªå´©ï¼š

1. **é›ªå´©åŸç†**ï¼šæ•…éšœæ²¿ç€è°ƒç”¨é“¾å‘ä¸Šä¼ æ’­ï¼Œå¯¼è‡´è¿é”ååº”
2. **æ ¸å¿ƒé—®é¢˜**ï¼šåŒæ­¥é˜»å¡ã€æ— ç†”æ–­æœºåˆ¶ã€èµ„æºè€—å°½
3. **è§£å†³æ–¹æ¡ˆ**ï¼šå¤šå±‚ç†”æ–­éš”ç¦»ï¼Œæ¯ä¸€å±‚å¯¹ä¸‹æ¸¸è¿›è¡Œç†”æ–­ä¿æŠ¤
4. **é™çº§ç­–ç•¥**ï¼šè¿”å›ç¼“å­˜ã€é»˜è®¤å€¼ã€å‹å¥½æç¤º
5. **æ•…éšœæ³¨å…¥æµ‹è¯•**ï¼šæ¨¡æ‹ŸçœŸå®æ•…éšœï¼ŒéªŒè¯ç†”æ–­æ•ˆæœ
6. **æœ€ä½³å®è·µ**ï¼šå¤šå±‚é˜²æŠ¤ã€ç›‘æ§å‘Šè­¦ã€å‹æµ‹éªŒè¯

**æ ¸å¿ƒè¦ç‚¹**ï¼š

> ç†”æ–­é™çº§ä¸æ˜¯"æ”¾å¼ƒ"ï¼Œè€Œæ˜¯"æ–­è‡‚æ±‚ç”Ÿ"ã€‚é€šè¿‡ä¸»åŠ¨ç†”æ–­æ•…éšœæœåŠ¡ï¼Œå¯ä»¥ä¿æŠ¤æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œé¿å…é›ªå´©æ•ˆåº”ã€‚

**ç¬¬ä¸‰é˜¶æ®µå®Œç»“**ï¼š

æ­å–œä½ å®Œæˆäº†Sentinelç†”æ–­é™çº§ç¯‡çš„å­¦ä¹ ï¼æˆ‘ä»¬ç³»ç»Ÿåœ°å­¦ä¹ äº†ï¼š
- ç†”æ–­åŸç†å’ŒçŠ¶æ€æœº
- ä¸‰ç§ç†”æ–­ç­–ç•¥ï¼ˆæ…¢è°ƒç”¨æ¯”ä¾‹ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°ï¼‰
- é™çº§è§„åˆ™å’Œè‡ªå®šä¹‰é™çº§å¤„ç†
- åŠå¼€çŠ¶æ€å’Œæ¢å¤æœºåˆ¶
- é˜²æ­¢å¾®æœåŠ¡é›ªå´©çš„å®Œæ•´æ–¹æ¡ˆ

**ä¸‹ä¸€é˜¶æ®µé¢„å‘Š**ï¼š

åœ¨ç¬¬å››é˜¶æ®µï¼ˆè¿›é˜¶ç‰¹æ€§ç¯‡ï¼‰ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š
- ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ï¼šLoadã€CPUã€RTå…¨æ–¹ä½é˜²æŠ¤
- çƒ­ç‚¹å‚æ•°é™æµï¼šä¿æŠ¤çƒ­ç‚¹æ•°æ®
- é»‘ç™½åå•ä¸æˆæƒè§„åˆ™
- é›†ç¾¤æµæ§ï¼šè·¨å®ä¾‹çš„æµé‡ç®¡ç†
- ç½‘å…³æµæ§ï¼šç»Ÿä¸€æµé‡å…¥å£çš„é˜²æŠ¤
- åŠ¨æ€è§„åˆ™é…ç½®ï¼šä»ç¡¬ç¼–ç åˆ°é…ç½®ä¸­å¿ƒ

æ•¬è¯·æœŸå¾…ï¼
